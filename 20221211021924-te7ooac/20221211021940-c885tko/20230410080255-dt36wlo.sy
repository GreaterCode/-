{
	"ID": "20230410080255-dt36wlo",
	"Spec": "1",
	"Type": "NodeDocument",
	"Properties": {
		"id": "20230410080255-dt36wlo",
		"scroll": "{\u0026quot;startId\u0026quot;:\u0026quot;20230410080255-lbabm85\u0026quot;,\u0026quot;endId\u0026quot;:\u0026quot;20230410080255-hvvcmke\u0026quot;,\u0026quot;scrollTop\u0026quot;:300,\u0026quot;focusId\u0026quot;:\u0026quot;20230410080255-u3izkfh\u0026quot;,\u0026quot;focusStart\u0026quot;:12,\u0026quot;focusEnd\u0026quot;:12}",
		"title": "kubelet PLEG 的实现与优化 ",
		"updated": "20230420152215"
	},
	"Children": [
		{
			"ID": "20230410080255-lbabm85",
			"Type": "NodeThematicBreak",
			"Properties": {
				"id": "20230410080255-lbabm85"
			}
		},
		{
			"ID": "20230410080255-r8nfs7d",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230410080255-r8nfs7d"
			},
			"Children": [
				{
					"ID": "20230410080255-jk4jxbc",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230410080255-jk4jxbc"
					},
					"Children": [
						{
							"ID": "20230410080255-944zz4u",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230410080255-944zz4u"
							},
							"Children": [
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://www.myway5.com/index.php/2023/02/27/kubelet-pleg-%e7%9a%84%e5%ae%9e%e7%8e%b0%e4%b8%8e%e4%bc%98%e5%8c%96/",
									"TextMarkTextContent": "https://www.myway5.com/index.php/2023/02/27/kubelet-pleg-%e7%9a%84%e5%ae%9e%e7%8e%b0%e4%b8%8e%e4%bc%98%e5%8c%96/ - 一只安静的猫"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230410080255-otzji74",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20230410080255-otzji74"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "概述"
				}
			]
		},
		{
			"ID": "20230410080255-ainrkr2",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230410080255-ainrkr2"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "PLEG"
				},
				{
					"Type": "NodeText",
					"Data": " 全称是  "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "Pod Lifecycle Event Generator"
				},
				{
					"Type": "NodeText",
					"Data": " ，用来为 kubelet 生成 container runtime 的 pod 生命周期事件，这样 kubelet 就可以根据 pod 的 spec 和 status 对比，来执行对应的控制逻辑。"
				}
			]
		},
		{
			"ID": "20230410080255-todw1tc",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230410080255-todw1tc"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "在 1.1 及之前的 kubelet 中是没有 PLEG 的实现的。kubelet 会为每个 pod 单独启动一个 worker，这个 worker 负责向 container runtime  查询该 pod 对应的 sandbox 和 container 的状态，并进行状态同步逻辑的执行。这种 one worker per pod 的 polling 模型给 kubelet 带来了较大的性能损耗。即使这个 pod 没有任何的状态变化，也要不停的对 container runtime  进行主动查询。"
				}
			]
		},
		{
			"ID": "20230410080255-mlaln28",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230410080255-mlaln28"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "因此在 1.2 中，kubelet 引入了 PLEG，将所有 container runtime  上 sandbox 和 container 的状态变化事件统一到 PLEG 这个单独的组件中，实现了 one worker all pods。这种实现相比于 one worker per pod 已经带来了较大的性能提升，详细实现会在后文进行介绍。但是默认情况下，仍然需要每秒一次的主动向 container runtime 查询，在 node 负载很高的情况下，依然会有一定的性能问题，比较常见的情况是导致 node not ready，错误原因是 "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "code",
					"TextMarkTextContent": "PLEG is not healthy"
				},
				{
					"Type": "NodeText",
					"Data": "。"
				}
			]
		},
		{
			"ID": "20230410080255-6lwl8ur",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230410080255-6lwl8ur"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "在 1.26 中，kubelet 引入了 Evented PLEG，为了和之前的 PLEG 实现区别，之前的 PLEG 称为 Generic PLEG。当然，Evented PLEG 并不是为了取代 Generic PLEG，而是和 Generic PLEG 配合，降低 Generic PLEG 的 polling 频率，从而提高性能的同时，也能保证实时性。"
				}
			]
		},
		{
			"ID": "20230410080255-u3izkfh",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20230410080255-u3izkfh"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "Generic PLEG"
				}
			]
		},
		{
			"ID": "20230410080255-kluc4s6",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230410080255-kluc4s6"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "Generic PLEG 定时(默认1s)向 runtime 进行查询，这个过程称为 relist，这里会调用 cri 的 "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "code",
					"TextMarkTextContent": "ListPodSandbox"
				},
				{
					"Type": "NodeText",
					"Data": " 和 "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "code",
					"TextMarkTextContent": "ListContainers"
				},
				{
					"Type": "NodeText",
					"Data": "接口。runtime 返回所有的数据之后，PLEG 会根据 sandbox 和 container 上的数据，对应的 Pod 上，并更新到缓存中。同时，组装成事件向 PLEG Channel 发送。"
				}
			]
		},
		{
			"ID": "20230410080255-412wbyr",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230410080255-412wbyr"
			},
			"Children": [
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "https://www.myway5.com/wp-content/uploads/2023/02/Snipaste_2023-02-27_16-10-20.png"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "assets/Snipaste_2023-02-27_16-10-20-20230410080255-w4xw65d.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				}
			]
		},
		{
			"ID": "20230410080255-yje6ff3",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230410080255-yje6ff3"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "kubelet 会在 pod sync loop 中监听 PLEG Channel，从而针对状态变化执行相应的逻辑，来尽量保证 pod spec 和 status 的一致。"
				}
			]
		},
		{
			"ID": "20230410080255-5sztwea",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20230410080255-5sztwea"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "Evented PLEG"
				}
			]
		},
		{
			"ID": "20230410080255-xe7sb57",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230410080255-xe7sb57"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "引入 Evented PLEG 后，对 Generic PLEG 做了些许调整，主要是 relist 的周期和阈值，以及对缓存的更新策略。"
				}
			]
		},
		{
			"ID": "20230410080255-r8glet4",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230410080255-r8glet4"
			},
			"Children": [
				{
					"ID": "20230410080255-bj02jmh",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230410080255-bj02jmh"
					},
					"Children": [
						{
							"ID": "20230410080255-3sjo0fh",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230410080255-3sjo0fh"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "relist 的同步周期由 1s 增加到 300s。同步阈值从 3min 增加到 10min。"
								}
							]
						}
					]
				},
				{
					"ID": "20230410080255-4c3bnmq",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230410080255-4c3bnmq"
					},
					"Children": [
						{
							"ID": "20230410080255-eid6evc",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230410080255-eid6evc"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "缓存更新时，updateTime 不再是取本地的时间，而是 runtime 返回的时间。"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230410080255-pmo4b47",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230410080255-pmo4b47"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "除此之外，Generic PLEG 会和之前一样运行，这样也保证了及时 Evented PLEG 丢失了一些 状态变更的 event，也可以由 Generic PLEG 兜底。"
				}
			]
		},
		{
			"ID": "20230410080255-zwlux0z",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230410080255-zwlux0z"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "Evented PLEG 会调用 runtime 的 "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "code",
					"TextMarkTextContent": "GetContainerEvents"
				},
				{
					"Type": "NodeText",
					"Data": " 来监听 runtime 中的事件，然后生成 pod 的 event，并发送到 PLEG Channel 中供 kubelet pod sync loop 消费。"
				}
			]
		},
		{
			"ID": "20230410080255-q5jdi2j",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230410080255-q5jdi2j"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "如果 Evented 不能按照预期工作（比如 runtime 不支持 GetContainerEvents），还会降级到 Generic PLEG。降级逻辑是："
				}
			]
		},
		{
			"ID": "20230410080255-lsqbf5v",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230410080255-lsqbf5v"
			},
			"Children": [
				{
					"ID": "20230410080255-gohp9vl",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230410080255-gohp9vl"
					},
					"Children": [
						{
							"ID": "20230410080255-kjujz7p",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230410080255-kjujz7p"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "停止自己。"
								}
							]
						}
					]
				},
				{
					"ID": "20230410080255-zr6yjcp",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230410080255-zr6yjcp"
					},
					"Children": [
						{
							"ID": "20230410080255-b47axhf",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230410080255-b47axhf"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "停止已有的 Generic PLEG。"
								}
							]
						}
					]
				},
				{
					"ID": "20230410080255-j7c6vn8",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230410080255-j7c6vn8"
					},
					"Children": [
						{
							"ID": "20230410080255-q3anxja",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230410080255-q3anxja"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "更新 Generic PLEG 的 relist 周期和阈值为 1s, 3min。"
								}
							]
						}
					]
				},
				{
					"ID": "20230410080255-ursjsq6",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230410080255-ursjsq6"
					},
					"Children": [
						{
							"ID": "20230410080255-nv551jm",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230410080255-nv551jm"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "启动新的 Generic PLEG。"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230410080255-on2kkzu",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230410080255-on2kkzu"
			},
			"Children": [
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "https://www.myway5.com/wp-content/uploads/2023/02/Snipaste_2023-02-27_16-58-56.png"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "assets/Snipaste_2023-02-27_16-58-56-20230410080255-yi6340y.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				}
			]
		},
		{
			"ID": "20230410080255-4bxtsed",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230410080255-4bxtsed"
			},
			"Children": [
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "https://www.myway5.com/wp-content/uploads/2023/02/Snipaste_2023-02-27_16-10-20-1.png"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "assets/Snipaste_2023-02-27_16-10-20-1-20230410080255-l6etbiy.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				}
			]
		},
		{
			"ID": "20230410080255-or3kj0p",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230410080255-or3kj0p"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "因为 Evented PLEG 和 Generic PLEG 会同时更新缓存，所以在更新时还会对比当前值和缓存值的时间戳，保证当前值是更新的状态，才会更新到缓存中。"
				}
			]
		},
		{
			"ID": "20230410080255-ces5oql",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20230410080255-ces5oql"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "参考文章"
				}
			]
		},
		{
			"ID": "20230410080255-kpzneid",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230410080255-kpzneid"
			},
			"Children": [
				{
					"ID": "20230410080255-rwsddos",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230410080255-rwsddos"
					},
					"Children": [
						{
							"ID": "20230410080255-4gc57ht",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230410080255-4gc57ht"
							},
							"Children": [
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://github.com/kubernetes/community/blob/4026287dc3a2d16762353b62ca2fe4b80682960a/contributors/design-proposals/node/pod-lifecycle-event-generator.md#leverage-upstream-container-events",
									"TextMarkTextContent": "Kubelet: Pod Lifecycle Event Generator (PLEG)"
								}
							]
						}
					]
				},
				{
					"ID": "20230410080255-m1g1s6k",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230410080255-m1g1s6k"
					},
					"Children": [
						{
							"ID": "20230410080255-ccd7gab",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230410080255-ccd7gab"
							},
							"Children": [
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://github.com/kubernetes/enhancements/blob/master/keps/sig-node/3386-kubelet-evented-pleg/README.md",
									"TextMarkTextContent": "KEP-3386: Kubelet Evented PLEG for Better Performance"
								}
							]
						},
						{
							"ID": "20230410080255-kj69u67",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230410080255-kj69u67"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "## 文章导航"
								}
							]
						},
						{
							"ID": "20230410080255-eewmz35",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230410080255-eewmz35"
							},
							"Children": [
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://www.myway5.com/index.php/2023/02/18/traceroute-%e7%9a%84%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86/",
									"TextMarkTextContent": " 上篇文章： Traceroute 的实现原理"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230410080255-hvvcmke",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230410080255-hvvcmke"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://www.myway5.com/index.php/2023/03/08/runc-%e7%9a%84%e8%be%93%e5%85%a5%e8%be%93%e5%87%ba/",
					"TextMarkTextContent": " 下篇文章： runc 的输入输出"
				}
			]
		}
	]
}