{
	"ID": "20220817100002-y09spew",
	"Spec": "1",
	"Type": "NodeDocument",
	"Properties": {
		"id": "20220817100002-y09spew",
		"scroll": "{\u0026quot;startId\u0026quot;:\u0026quot;20220817100002-ti6818f\u0026quot;,\u0026quot;endId\u0026quot;:\u0026quot;20230325184748-8flbzdi\u0026quot;,\u0026quot;scrollTop\u0026quot;:10266}",
		"title": "etcd容量满",
		"updated": "20230325185115"
	},
	"Children": [
		{
			"ID": "20220817100002-ti6818f",
			"Type": "NodeThematicBreak",
			"Properties": {
				"id": "20220817100002-ti6818f"
			}
		},
		{
			"ID": "20220817100002-di1ubbq",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20220817100002-di1ubbq",
				"updated": "20220817100002"
			},
			"Children": [
				{
					"ID": "20220817100002-uhxbkhg",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20220817100002-uhxbkhg",
						"updated": "20220817100002"
					},
					"Children": [
						{
							"ID": "20220817100002-tmz5n8e",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20220817100002-tmz5n8e",
								"updated": "20220817100002"
							},
							"Children": [
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://www.notion.so/etcd-9bd1ec867410414aafbaa942e73106a6",
									"TextMarkTextContent": "https://www.notion.so/etcd-9bd1ec867410414aafbaa942e73106a6 - Notion"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20220817100002-6asdkob",
			"Type": "NodeThematicBreak",
			"Properties": {
				"id": "20220817100002-6asdkob"
			}
		},
		{
			"ID": "20220817100002-jnnma8y",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-jnnma8y"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "环境和部分软件已经配置好了，接着要部署一个"
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://so.csdn.net/so/search?q=Etcd",
					"TextMarkTextContent": "Etcd"
				},
				{
					"Type": "NodeText",
					"Data": "集群。Etcd 通常是和master部署在一起,也有人会将 etcd独立于 k8s集群之外,以便于更好地扩展etcd集群。而此次是部署在3个master上。"
				}
			]
		},
		{
			"ID": "20220817100002-cd6ego6",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-cd6ego6"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "Etcd节点数：\netcd 是基于raft算法的分布式键值数据库,在做决策时需要超半数节点的投票,所以 etcd集群 一般推荐奇数节点(3,5,7);etcd是高可用的,3节点etcd集群,最大容忍1台机器宕机。根据网上的资料：设置偶数节点也是可以的,但是会拉低写入速度。节点数越多，性能越差。"
				}
			]
		},
		{
			"ID": "20220817100002-taztdg7",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-taztdg7",
				"updated": "20230325184645"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "限制Etcd性能的因素:"
				}
			]
		},
		{
			"ID": "20230325184645-oqnr3ph",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230325184645-oqnr3ph",
				"updated": "20230325184645"
			},
			"Children": [
				{
					"ID": "20230325184645-dacaii8",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230325184645-dacaii8"
					},
					"Children": [
						{
							"ID": "20230325184645-w2c7rcf",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230325184645-w2c7rcf"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "单机的容量限制,内存和磁盘(这基本上是大部分服务的主要限制因素之一。可使用ionice调高etcd进程的IO优先级；部署etcd集群使用性能较高,内存较大的服务器，如果是云服务器可选择高性能云盘）"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20220817100002-bpswr2a",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-bpswr2a",
				"updated": "20230325184553"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "code",
					"TextMarkTextContent": "ionice -c2 -n0 -p pgrep etcd"
				}
			]
		},
		{
			"ID": "20220817100002-c3gcemt",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-c3gcemt"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "Etcd配置的容量上限（Etcd默认配置的容量上限较小。当ETCD的存储使用超过了空间配额,ETCD 将发起集群范围的警告，并使集群进入维护模式,仅接收键的读取和删除，从而影响平台的正常运行。因此需要部署时调整ETCD 容量上限)"
				}
			]
		},
		{
			"ID": "20220817100002-303e6ou",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-303e6ou",
				"updated": "20220817100002"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "网络开销（每次 Raft 操作都需要所有节点参与。每一次写操作需要集群中大多数节点将日志落盘成功后,Leader节点才能修改内部状态，并将结果返回给客户端。频繁的交互，对网络的要求较高。因此通常会将 etcd 集群规划在一个网络环境中（同地域/同机房),并且使用tc提高带宽和优先级）"
				}
			]
		},
		{
			"ID": "20230325184604-d7ic77t",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230325184604-d7ic77t",
				"updated": "20230325184612"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "XA=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "tc qdisc add dev eth0 root handle 1: prio bands 3\ntc filter add dev eth0 parent 1: protocol ip prio 1 u32 match ip sport 2380 0xffff flowid 1:1\ntc filter add dev eth0 parent 1: protocol ip prio 1 u32 match ip dport 2380 0xffff flowid 1:1\ntc filter add dev eth0 parent 1: protocol ip prio 2 u32 match ip sport 2739 0xffff flowid 1:1\ntc filter add dev eth0 parent 1: protocol ip prio 2 u32 match ip dport 2739 0xffff flowid 1:1\n\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20220817100002-auepzzz",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-auepzzz",
				"updated": "20230325184610"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "以下操作在 etcd1(即master01)机器执行"
				}
			]
		},
		{
			"ID": "20230325184531-aaumgsa",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230325184531-aaumgsa",
				"updated": "20230325184542"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "XA=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "curl -o /usr/bin/cfssl [https://pkg.cfssl.org/R1.2/cfssl_linux-amd64](https://pkg.cfssl.org/R1.2/cfssl_linux-amd64)\ncurl -o /usr/bin/cfssljson [https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64](https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64)\ncurl -o /usr/bin/cfssl-certinfo [https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64](https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64)\nchmod +x /usr/bin/cfssl*\n\nmkdir -p /etc/kubernetes/pki/etcd\ncd /etc/kubernetes/pki/etcd\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20220817100002-p1d68sh",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-p1d68sh"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "根据需求创建目录，实际建议etcd证书放到其他位置（当证书放到/etc/kubernetes时，虽然便于统一管理，但kubeadm reset后，etcd的证书也会丢失。如不想重新配置etcd，建议证书放到其他位置）"
				}
			]
		},
		{
			"ID": "20220817100002-cjop45k",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-cjop45k",
				"updated": "20220817100002"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "\u003c3\u003e创建 CA 配置文件（ca-config.json）"
				}
			]
		},
		{
			"ID": "20230325184704-4bl5xwn",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230325184704-4bl5xwn",
				"updated": "20230325184714"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "XA=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "cat \u003eca-config.json \u003c\u003cEOF\n{\n  \"signing\": {\n    \"default\": {\n      \"expiry\": \"876000h\"\n    },\n    \"profiles\": {\n      \"etcd\": {\n        \"usages\": [\n            \"signing\",\n            \"key encipherment\",\n            \"server auth\",\n            \"client auth\"\n        ],\n        \"expiry\": \"876000h\"\n      }\n    }\n  }\n}\nEOF\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20220817100002-ls1isfn",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-ls1isfn",
				"updated": "20230325184709"
			}
		},
		{
			"ID": "20220817100002-f11wo6w",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-f11wo6w"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "or\n使用命令生成，然后对其进行修改\ncfssl print-defaults config \u003e ca-config.json"
				}
			]
		},
		{
			"ID": "20220817100002-hkvqae5",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-hkvqae5"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "备注:"
				}
			]
		},
		{
			"ID": "20220817100002-vk7rbop",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-vk7rbop"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "\"ca-config.json\"：  可以定义多个profiles，分别指定不同的过期时间、使用场景等参数\n\"signing\"：         表示该证书可用于签名其它证书\n\"expiry\"：          表示证书的有效时间(876000h=100年)，根据需求配置\n\"key encipherment\"：密钥加密\n\"server auth\"：     表示client可以用该 CA 对server提供的证书进行验证\n\"client auth\"：     表示server可以用该CA对client提供的证书进行验证"
				}
			]
		},
		{
			"ID": "20220817100002-3ymb4bp",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-3ymb4bp"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "\u003c4\u003e创建 CA 证书签名请求（ca-csr.json）"
				}
			]
		},
		{
			"ID": "20220817100002-cn2vcnd",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-cn2vcnd"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "cat \u003eca-csr.json \u003c\u003cEOF\n{\n  \"CN\": \"etcd\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"shanghai\",\n      \"L\": \"shanghai\",\n      \"O\": \"etcd\",\n      \"OU\": \"System\"\n    }\n  ]\n}\nEOF"
				}
			]
		},
		{
			"ID": "20220817100002-smmrz4s",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-smmrz4s"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "or\n使用命令生成，然后对其进行修改\ncfssl print-defaults csr \u003e ca-csr.json"
				}
			]
		},
		{
			"ID": "20220817100002-cat6z66",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-cat6z66"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "备注:"
				}
			]
		},
		{
			"ID": "20220817100002-8td4e55",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-8td4e55"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "\"CN\"：   etcd会从证书中提取该字段作为请求的用户名，根据需求起名字\n\"O\"：    etcd 从证书中提取该字段作为请求用户所属的组"
				}
			]
		},
		{
			"ID": "20220817100002-bvy25fo",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-bvy25fo"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "\"C\"：    国家编码\n\"ST\"：   省份\n\"L\"：    市/区\n\"O\"：    公司名称\n\"OU\"：   部门名称\n随意填即可"
				}
			]
		},
		{
			"ID": "20220817100002-nne48sd",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-nne48sd"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "cfssl gencert -initca ca-csr.json | cfssljson -bare ca"
				}
			]
		},
		{
			"ID": "20220817100002-xjmoabz",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-xjmoabz"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "生成下面3个文件\nca.pem      根证书公钥文件,用于签发后续其他的证书文件\nca-key.pem  根证书私钥文件\nca.csr      证书签名请求，用于交叉签名或重新签名"
				}
			]
		},
		{
			"ID": "20220817100002-3m54dji",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-3m54dji"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "简洁型ca脚本："
				}
			]
		},
		{
			"ID": "20220817100002-63ip269",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-63ip269"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "cat \u003eca-config.json \u003c\u003cEOF\n{\n  \"signing\": {\n    \"default\": {\n      \"expiry\": \"876000h\"\n    },\n    \"profiles\": {\n      \"etcd\": {\n        \"usages\": [\n            \"signing\",\n            \"key encipherment\",\n            \"server auth\",\n            \"client auth\"\n        ],\n        \"expiry\": \"876000h\"\n      }\n    }\n  }\n}\nEOF"
				}
			]
		},
		{
			"ID": "20220817100002-duupcqq",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-duupcqq"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "cat \u003eca-csr.json \u003c\u003cEOF\n{\n  \"CN\": \"etcd\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"shanghai\",\n      \"L\": \"shanghai\",\n      \"O\": \"etcd\",\n      \"OU\": \"System\"\n    }\n  ]\n}\nEOF"
				}
			]
		},
		{
			"ID": "20220817100002-bkahth4",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-bkahth4"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "cfssl gencert -initca ca-csr.json | cfssljson -bare ca"
				}
			]
		},
		{
			"ID": "20220817100002-si3w0f9",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-si3w0f9"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "#创建 etcd证书签名请求（etcd-csr.json）"
				}
			]
		},
		{
			"ID": "20220817100002-yne8s06",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-yne8s06"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "cat \u003e etcd-csr.json \u003c\u003cEOF\n{\n  \"CN\": \"etcd\",\n  \"hosts\": [\n    \"192.168.1.1\",\n    \"192.168.1.2\",\n    \"192.168.1.3\",\n    \"k8s-master01\",\n    \"k8s-master02\",\n    \"k8s-master03\"\n  ],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"shanghai\",\n      \"L\": \"shanghai\",\n      \"O\": \"etcd\",\n      \"OU\": \"System\"\n    }\n  ]\n}\nEOF"
				}
			]
		},
		{
			"ID": "20220817100002-zamtvdm",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-zamtvdm"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "备注:"
				}
			]
		},
		{
			"ID": "20220817100002-mu722x5",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-mu722x5"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "\"hosts\"： 指定授权使用该证书的IP和域名列表（即指定了etcd集群各个节点的IP/域名）"
				}
			]
		},
		{
			"ID": "20220817100002-opdoui7",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-opdoui7"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=etcd etcd-csr.json | cfssljson -bare etcd"
				}
			]
		},
		{
			"ID": "20220817100002-1xvvahy",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-1xvvahy"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "生成下面3个文件\netcd.csr\netcd.pem\netcd-key.pem"
				}
			]
		},
		{
			"ID": "20220817100002-l4lkm1j",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-l4lkm1j"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "本次etcd部署在master上，且由于在初始化阶段，master间进行了免密认证，直接推送即可。\n重点在于将前面生成的证书拷贝到其他节点。"
				}
			]
		},
		{
			"ID": "20220817100002-e4sg83o",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-e4sg83o"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "rsync -aP  /etc/kubernetes  root@k8s-master02:/etc/\nrsync -aP  /etc/kubernetes  root@k8s-master03:/etc/"
				}
			]
		},
		{
			"ID": "20220817100002-813d5mt",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-813d5mt"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "简洁型etcd证书脚本："
				}
			]
		},
		{
			"ID": "20220817100002-0fuee0x",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-0fuee0x"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "cat \u003e etcd-csr.json \u003c\u003cEOF\n{\n  \"CN\": \"etcd\",\n  \"hosts\": [\n    \"192.168.1.1\",\n    \"192.168.1.2\",\n    \"192.168.1.3\",\n    \"k8s-master01\",\n    \"k8s-master02\",\n    \"k8s-master03\"\n  ],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"shanghai\",\n      \"L\": \"shanghai\",\n      \"O\": \"etcd\",\n      \"OU\": \"System\"\n    }\n  ]\n}\nEOF"
				}
			]
		},
		{
			"ID": "20220817100002-x5mzx3x",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-x5mzx3x"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=etcd etcd-csr.json | cfssljson -bare etcd"
				}
			]
		},
		{
			"ID": "20220817100002-a3drsqk",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-a3drsqk"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "rsync -aP  /etc/kubernetes  root@k8s-master02:/etc/\nrsync -aP  /etc/kubernetes  root@k8s-master03:/etc/"
				}
			]
		},
		{
			"ID": "20220817100002-u1upzxu",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-u1upzxu"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "\u003c1\u003e创建etcd数据目录\n(统一的数据目录，可便于管理)"
				}
			]
		},
		{
			"ID": "20220817100002-j4b6pmp",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-j4b6pmp"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "mkdir -p /data/etcd\nchmod -R 777 /data/etcd\nln -s /data/etcd /var/lib/etcd"
				}
			]
		},
		{
			"ID": "20220817100002-9hkmwyc",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-9hkmwyc"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "版本建议选择3.4及其以上，3.4存储容量做了提升，降低了读写延迟；且3.3以下等版本存在数据不一致的bug"
				}
			]
		},
		{
			"ID": "20220817100002-8fp8e5e",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-8fp8e5e"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "export ETCD_VERSION=v3.4.4\ncurl -sSL "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://github.com/coreos/etcd/releases/download/$%7BETCD_VERSION%7D/etcd-$%7BETCD_VERSION%7D-linux-amd64.tar.gz",
					"TextMarkTextContent": "https://github.com/coreos/etcd/releases/download/${ETCD_VERSION}/etcd-${ETCD_VERSION}-linux-amd64.tar.gz"
				},
				{
					"Type": "NodeText",
					"Data": " | tar -xzv --strip-components=1 -C /usr/local/bin/"
				}
			]
		},
		{
			"ID": "20220817100002-71ak68z",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-71ak68z"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "or\nwget "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://github.com/coreos/etcd/releases/download/v3.4.4/etcd-v3.4.4-linux-amd64.tar.gz",
					"TextMarkTextContent": "https://github.com/coreos/etcd/releases/download/v3.4.4/etcd-v3.4.4-linux-amd64.tar.gz"
				}
			]
		},
		{
			"ID": "20220817100002-qd3yfbe",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-qd3yfbe",
				"updated": "20220817100002"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "ETCD3.4版本会自动读取环境变量的参数，所以EnvironmentFile文件中有的参数，不需要再次在ExecStart启动参数中添加"
				}
			]
		},
		{
			"ID": "20230325185023-1s3rc8x",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230325185023-1s3rc8x",
				"updated": "20230325185115"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "XA=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "#!/bin/bash\n\ncat \u003e /etc/etcd.env \u003c\u003cEOF\nPEER_NAME=k8s-master01\nPRIVATE_IP=192.168.1.1\nETCD_CLUSTER=\"k8s-master01=https://192.168.1.1:2380,k8s-master02=https://192.168.1.2:2380,k8s-master03=https://192.168.1.3:2380\"\nETCD_INITIAL_CLUSTER_TOKEN=\"etcd-cluster-1\"\nEOF\n\ncat \u003e /etc/systemd/system/etcd.service  \u003c\u003cEOF\n[Unit]\nDescription=etcd\nDocumentation=https://github.com/coreos/etcd\nConflicts=etcd.service\nConflicts=etcd2.service\n\nExecStart=/usr/local/bin/etcd --name ${PEER_NAME} \\\\\n    --data-dir /var/lib/etcd \\\\\n    --listen-client-urls [https://$](https://$){PRIVATE_IP}:2379 \\\\\n    --advertise-client-urls [https://$](https://$){PRIVATE_IP}:2379 \\\\\n    --listen-peer-urls [https://$](https://$){PRIVATE_IP}:2380 \\\\\n    --initial-advertise-peer-urls [https://$](https://$){PRIVATE_IP}:2380 \\\\\n    --cert-file=/etc/kubernetes/pki/etcd/etcd.pem \\\\\n    --key-file=/etc/kubernetes/pki/etcd/etcd-key.pem \\\\\n    --client-cert-auth \\\\\n    --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.pem \\\\\n    --peer-cert-file=/etc/kubernetes/pki/etcd/etcd.pem \\\\\n    --peer-key-file=/etc/kubernetes/pki/etcd/etcd-key.pem \\\\\n    --peer-client-cert-auth \\\\\n    --peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.pem \\\\\n    --initial-cluster ${ETCD_CLUSTER} \\\\\n    --initial-cluster-token etcd-cluster-1 \\\\\n    --initial-cluster-state new\n\n[Install]\nWantedBy=multi-user.target\n\nEOF\n\n[Service]\nEnvironmentFile=/etc/etcd.env\nType=notify\nRestart=always\nRestartSec=5s\nLimitNOFILE=65536\nTimeoutStartSec=0\n\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20220817100002-lxeug2r",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-lxeug2r",
				"updated": "20230325185056"
			}
		},
		{
			"ID": "20220817100002-88cnptk",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-88cnptk",
				"updated": "20230325185113"
			}
		},
		{
			"ID": "20220817100002-xt1jtan",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-xt1jtan"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "需注意内容：\n2379是提供给外部端口，2380是内部集群通讯端口\nEnvironmentFile          指定环境变量文件\nExecStart                指定启动文件\n--data-dir               指定数据目录\n--listen-client-urls     对外提供服务的地址\n--listen-peer-urls       和成员之间通信的地址\n--initial-cluster-token  创建集群的 token，这个值每个集群保持唯一\n--client-cert-auth       启用客户端证书验证\n--peer-client-cert-auth  启用对等客户端证书验证\n--initial-cluster-state  集群状态，默认为new（初始时建议设置为new。当一个节点故障后恢复时，该节点调整为existing，etcd将尝试使其加入现有群集）"
				}
			]
		},
		{
			"ID": "20220817100002-a561pos",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-a561pos",
				"updated": "20220817100002"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "下列参数皆为指定密钥文件，就不具体介绍了"
				}
			]
		},
		{
			"ID": "20230325184909-9kfj7gx",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230325184909-9kfj7gx",
				"updated": "20230325184919"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "XA=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "--cert-file\n--key-file\n--client-cert-auth\n--trusted-ca-file\n--peer-cert-file\n--peer-key-file\n--peer-client-cert-auth\n--peer-trusted-ca-file\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20220817100002-y0gcg0t",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-y0gcg0t"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "下列参数可写入配置文件，也可用命令调整\n当开启证书验证，如果需要使用命令调整参数，需要加上证书，否则无法执行"
				}
			]
		},
		{
			"ID": "20220817100002-6k1scy4",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20220817100002-6k1scy4",
				"updated": "20230325184923"
			},
			"Children": [
				{
					"ID": "20230325184923-a2r3t7u",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230325184923-a2r3t7u"
					},
					"Children": [
						{
							"ID": "20230325184923-w1f4ggs",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230325184923-w1f4ggs"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "--heartbeat-interval     心跳间隔的时间（以毫秒为单位）默认100\n应该被设置为节点之间网络往返时间,节点网络延迟较高时，可适当调高(跨机房/地域，通常最高为5s）"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20220817100002-fjylfvv",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20220817100002-fjylfvv",
				"updated": "20230325184928"
			},
			"Children": [
				{
					"ID": "20230325184928-s3i55s8",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230325184928-s3i55s8"
					},
					"Children": [
						{
							"ID": "20230325184928-vdti3sk",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230325184928-vdti3sk"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "--election-timeout       选举超时的时间（以毫秒为单位）默认1000\n不均匀的网络性能或者常规的网络延迟和丢失，会引起多次网络重试，延迟过大可调高超时时间最高值应该是50s\n调参命令:etcd --heartbeat-interval=100 --election-timeout=500"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20220817100002-rft9fbn",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20220817100002-rft9fbn",
				"updated": "20230325184939"
			},
			"Children": [
				{
					"ID": "20230325184939-ft508ve",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230325184939-ft508ve"
					},
					"Children": [
						{
							"ID": "20230325184939-t8utq5v",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230325184939-t8utq5v"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "--max-snapshots          要保留的最大快照文件数（0表示不受限制）默认5"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20220817100002-bzs2lxi",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20220817100002-bzs2lxi",
				"updated": "20230325184942"
			},
			"Children": [
				{
					"ID": "20230325184942-avszkdz",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230325184942-avszkdz"
					},
					"Children": [
						{
							"ID": "20230325184942-q50dvdt",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230325184942-q50dvdt"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "--snapshot-count         触发快照到磁盘的已提交事务数。默认100000\n当参数累积到一定的数量时，Etcd 才会创建快照文件。如果 Etcd的内存使用和磁盘使用过高，可调低快照触发的阈值5000\n调参命令：etcd --snapshot-count=5000"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20220817100002-ozqdnkr",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20220817100002-ozqdnkr",
				"updated": "20230325184949"
			},
			"Children": [
				{
					"ID": "20230325184949-kpkbosr",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230325184949-kpkbosr"
					},
					"Children": [
						{
							"ID": "20230325184949-z1x63as",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230325184949-z1x63as"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "--auto-compaction-retention  自动压缩，默认为0不开启(默认小时为单位)。etcd会存储多版本数据，随着写入的主键增加，历史版本将会越来越多,并且默认不清理。可根据需求，设置压缩时间间隔。\n调参命令:etcd --auto-compaction-retention=1"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20220817100002-w6eoqug",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20220817100002-w6eoqug",
				"updated": "20230325184952"
			},
			"Children": [
				{
					"ID": "20230325184952-bc4q0d9",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230325184952-bc4q0d9"
					},
					"Children": [
						{
							"ID": "20230325184952-1mj6afz",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230325184952-1mj6afz"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "--max-request-bytes      服务器将接受的最大客户端请求大小(字节)默认1572864，1.5M\n官方推荐的是10M，建议根据需求自行调整"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20220817100002-puqkdik",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20220817100002-puqkdik",
				"updated": "20230325184956"
			},
			"Children": [
				{
					"ID": "20230325184956-heeip55",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230325184956-heeip55"
					},
					"Children": [
						{
							"ID": "20230325184956-74s5it2",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230325184956-74s5it2"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "--quota-backend-bytes    当后端db数据大小超过给定配额时，引发警报并不允许写入，空间释放足够的空间之后，警告可以被解除，而集群将恢复正常运作，默认是2G\n官方推荐是8G配置,也可根据需求配置100G，并不是越大越好，key存储越多性能越差\n调参命令:etcd --max-request-bytes="
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "inline-math",
									"TextMarkInlineMathContent": "((32*1024*1024)) --quota-backend-bytes="
								},
								{
									"Type": "NodeText",
									"Data": "((8"
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "em",
									"TextMarkTextContent": "1024"
								},
								{
									"Type": "NodeText",
									"Data": "1024*1024))"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230325185004-4mqih31",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230325185004-4mqih31",
				"updated": "20230325185012"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "XA=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "systemctl daemon-reload\nsystemctl start etcd\nsystemctl enable etcd\nsystemctl status etcd -l\n\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20220817100002-x0r5mu9",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20220817100002-x0r5mu9",
				"updated": "20220817100002"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "如果启动失败，检测一下当前节点是否存在etcd证书"
				}
			]
		},
		{
			"ID": "20230325184748-8flbzdi",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230325184748-8flbzdi",
				"updated": "20230325184855"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "XA=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "cat etcd_healthy.sh\n\nHOST1=192.168.1.1\nHOST2=192.168.1.2\nHOST3=192.168.1.3\nENDPOINTS=$HOST1:2379,$HOST2:2379,$HOST3:2379\n\nKEY=\"--cacert=/etc/kubernetes/pki/etcd/ca.pem \\\\\n--cert=/etc/kubernetes/pki/etcd/etcd.pem \\\\\n--key=/etc/kubernetes/pki/etcd/etcd-key.pem\"\n\netcdctl --endpoints=$ENDPOINTS $KEY endpoint health\n\netcdctl --endpoints=$ENDPOINTS $KEY --write-out=table endpoint status\n\netcdctl --endpoints=$ENDPOINTS $KEY member list -w table\n\n172.22.57.184:2379 is healthy: successfully committed proposal: took = 10.085925ms\n172.22.57.185:2379 is healthy: successfully committed proposal: took = 10.220026ms\n172.22.57.187:2379 is healthy: successfully committed proposal: took = 11.350372ms\n+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n|      ENDPOINT      |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |\n+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n| 172.22.57.184:2379 | 4fdbc756dda5ffbb |   3.4.4 |  1.6 MB |     false |      false |        94 |     289210 |             289210 |        |\n| 172.22.57.187:2379 | c6c78a8f420b5599 |   3.4.4 |  1.6 MB |      true |      false |        94 |     289210 |             289210 |        |\n| 172.22.57.185:2379 | 3067cb577abc7d54 |   3.4.4 |  1.6 MB |     false |      false |        94 |     289210 |             289210 |        |\n+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n+------------------+---------+---------+----------------------------+----------------------------+------------+\n|        ID        | STATUS  |  NAME   |         PEER ADDRS         |        CLIENT ADDRS        | IS LEARNER |\n+------------------+---------+---------+----------------------------+----------------------------+------------+\n| 3067cb577abc7d54 | started | master3 | [https://172.22.57.185:2380](https://172.22.57.185:2380) | [https://172.22.57.185:2379](https://172.22.57.185:2379) |      false |\n| 4fdbc756dda5ffbb | started | master1 | [https://172.22.57.184:2380](https://172.22.57.184:2380) | [https://172.22.57.184:2379](https://172.22.57.184:2379) |      false |\n| c6c78a8f420b5599 | started | master2 | [https://172.22.57.187:2380](https://172.22.57.187:2380) | [https://172.22.57.187:2379](https://172.22.57.187:2379) |      false |\n+------------------+---------+---------+----------------------------+----------------------------+------------+\n\n\n#cat etcd_clean.sh\n\nHOST1=192.168.1.1\nHOST2=192.168.1.2\nHOST3=192.168.1.3\nENDPOINTS=$HOST1:2379,$HOST2:2379,$HOST3:2379\n\nKEY=\"--cacert=/etc/kubernetes/pki/etcd/ca.pem \\\\\n--cert=/etc/kubernetes/pki/etcd/etcd.pem \\\\\n--key=/etc/kubernetes/pki/etcd/etcd-key.pem\"\n\nrev=$(ETCDCTL_API=3 etcdctl --endpoints=$ENDPOINTS $KEY endpoint status --write-out=\"json\" | egrep -o '\"revision\":[0-9]*' | egrep -o '[0-9].*')\n\nETCDCTL_API=3 etcdctl --endpoints=${ENDPOINTS} ${KEY} compact $rev\n\nETCDCTL_API=3 etcdctl --endpoints=${ENDPOINTS} ${KEY} defrag\n\nETCDCTL_API=3 etcdctl --endpoints=${ENDPOINTS} ${KEY} alarm disarm\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		}
	]
}