{
	"ID": "20221128161802-eoh5gm7",
	"Spec": "1",
	"Type": "NodeDocument",
	"Properties": {
		"id": "20221128161802-eoh5gm7",
		"title": "8-NetworkPolicy日志和Webhook使用",
		"updated": "20221129015200"
	},
	"Children": [
		{
			"ID": "20221128161802-b4o1cxm",
			"Type": "NodeHeading",
			"HeadingLevel": 1,
			"Properties": {
				"id": "20221128161802-b4o1cxm",
				"updated": "20221129014054"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "1. NetworkPolicy日志"
				}
			]
		},
		{
			"ID": "20221129014105-4dq4nsa",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20221129014105-4dq4nsa",
				"updated": "20221129014105"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "NetworkPolicy 为 Kubernetes 提供的网络策略接口，Kube-OVN 通过 OVN 的 ACL 进行了实现。 使用了 NetworkPolicy 后如果出现网络不通的情况，难以判断是网络故障问题还是 NetworkPolicy 规则设置问题导致的网络中断。 Kube-OVN 提供了 NetworkPolicy 日志功能，帮助管理员快速定位 NetworkPolicy Drop 规则是否命中，并记录有哪些非法访问。"
				}
			]
		},
		{
			"ID": "20221129014105-roo3kt9",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20221129014105-roo3kt9",
				"updated": "20221129014117"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20221129014105-8jrw632",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20221129014105-8jrw632",
						"updated": "20221129014117"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "NetworkPolicy 日志功能一旦开启，对每个命中 Drop 规则的数据包都需要打印日志，会带来额外性能开销。 在恶意攻击下，短时间大量日志可能会耗尽 CPU。我们建议"
						},
						{
							"Type": "NodeTextMark",
							"TextMarkType": "mark",
							"TextMarkTextContent": "在生产环境默认关闭日志功能"
						},
						{
							"Type": "NodeText",
							"Data": "，在需要排查问题时，动态开启日志。"
						}
					]
				}
			]
		},
		{
			"ID": "20221129014119-ai87cgw",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20221129014119-ai87cgw",
				"updated": "20221129014228"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "1.1 开启NetworkPolicy日志"
				}
			]
		},
		{
			"ID": "20221129014228-kozgz6i",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20221129014228-kozgz6i",
				"updated": "20221129014234"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "在需要开启日志记录的 NetworkPolicy 中增加 annotation "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "code",
					"TextMarkTextContent": "ovn.kubernetes.io/enable_log"
				},
				{
					"Type": "NodeText",
					"Data": "，如下所示："
				}
			]
		},
		{
			"ID": "20221129014238-45nrtw0",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20221129014238-45nrtw0",
				"updated": "20221129014250"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "XA=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: default-deny-ingress\n  namespace: kube-system\n  annotations:\n    ovn.kubernetes.io/enable_log: \"true\"\nspec:\n  podSelector: {}\n  policyTypes:\n  - Ingress\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20221129014300-zrnu8ej",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20221129014300-zrnu8ej",
				"updated": "20221129014331"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "查看pod所在主机的"
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "code",
					"TextMarkTextContent": "/var/log/ovn/ovn-controller.log"
				},
				{
					"Type": "NodeText",
					"Data": " 中观察到被丢弃数据包的日志："
				}
			]
		},
		{
			"ID": "20221129014356-etc6a6d",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20221129014356-etc6a6d",
				"updated": "20221129014538"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "XA=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "# tail -f /var/log/ovn/ovn-controller.log\n2022-07-20T05:55:03.229Z|00394|acl_log(ovn_pinctrl0)|INFO|name=\"\u003cunnamed\u003e\", verdict=drop, severity=warning, direction=to-lport: udp,vlan_tci=0x0000,dl_src=00:00:00:21:b7:d1,dl_dst=00:00:00:8d:0b:86,nw_src=10.16.0.10,nw_dst=10.16.0.7,nw_tos=0,nw_ecn=0,nw_ttl=63,tp_src=54343,tp_dst=53\n2022-07-20T05:55:06.229Z|00395|acl_log(ovn_pinctrl0)|INFO|name=\"\u003cunnamed\u003e\", verdict=drop, severity=warning, direction=to-lport: udp,vlan_tci=0x0000,dl_src=00:00:00:21:b7:d1,dl_dst=00:00:00:8d:0b:86,nw_src=10.16.0.9,nw_dst=10.16.0.7,nw_tos=0,nw_ecn=0,nw_ttl=63,tp_src=44187,tp_dst=53\n2022-07-20T05:55:08.230Z|00396|acl_log(ovn_pinctrl0)|INFO|name=\"\u003cunnamed\u003e\", verdict=drop, severity=warning, direction=to-lport: udp,vlan_tci=0x0000,dl_src=00:00:00:21:b7:d1,dl_dst=00:00:00:8d:0b:86,nw_src=10.16.0.10,nw_dst=10.16.0.7,nw_tos=0,nw_ecn=0,nw_ttl=63,tp_src=54274,tp_dst=53\n2022-07-20T05:55:11.231Z|00397|acl_log(ovn_pinctrl0)|INFO|name=\"\u003cunnamed\u003e\", verdict=drop, severity=warning, direction=to-lport: udp,vlan_tci=0x0000,dl_src=00:00:00:21:b7:d1,dl_dst=00:00:00:8d:0b:86,nw_src=10.16.0.9,nw_dst=10.16.0.7,nw_tos=0,nw_ecn=0,nw_ttl=63,tp_src=32778,tp_dst=53\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20221129014542-oqf7s8f",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20221129014542-oqf7s8f",
				"updated": "20221129014548"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "1.2 关闭 NetworkPolicy 日志"
				}
			]
		},
		{
			"ID": "20221129014607-rl6iqhy",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20221129014607-rl6iqhy",
				"updated": "20221129014607"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "将对应 NetworkPolicy 中的 annotation "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "code",
					"TextMarkTextContent": "ovn.kubernetes.io/enable_log"
				},
				{
					"Type": "NodeText",
					"Data": " 设置为 "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "code",
					"TextMarkTextContent": "false"
				},
				{
					"Type": "NodeText",
					"Data": " 即可关闭 NetworkPolicy 日志："
				}
			]
		},
		{
			"ID": "20221129014612-ugls0r3",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20221129014612-ugls0r3",
				"updated": "20221129014612"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "kubectl annotate networkpolicy -n kube-system default-deny-ingress ovn.kubernetes.io/enable_log=false --overwrite\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20221129014802-z6uopdd",
			"Type": "NodeHeading",
			"HeadingLevel": 1,
			"Properties": {
				"id": "20221129014802-z6uopdd",
				"updated": "20221129014817"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2.Webhook使用"
				}
			]
		},
		{
			"ID": "20221129014843-0i6kxz0",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20221129014843-0i6kxz0",
				"updated": "20221129014843"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "使用 Webhook 可以对 Kube-OVN 内的 CRD 资源进行校验，目前 Webhook 主要完成 固定 IP 地址冲突检测和 Subnet CIDR 的冲突检测，并在这类资源创建冲突时提示错误。"
				}
			]
		},
		{
			"ID": "20221129014843-llqajea",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20221129014843-llqajea",
				"updated": "20221129014843"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "由于 Webhook 会拦截所有的 Subnet 和 Pod 创建的请求，因此需要先部署 Kube-OVN 后部署 Webhook 避免无法创建 Pod。"
				}
			]
		},
		{
			"ID": "20221129014939-r6acr7l",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20221129014939-r6acr7l",
				"updated": "20221129014946"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2.1 Cert-Manager 安装"
				}
			]
		},
		{
			"ID": "20221129014959-2iib6hl",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20221129014959-2iib6hl",
				"updated": "20221129015002"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "Webhook 部署需要相关证书加密，我们使用 cert-manager 生成相关证书，我们需要在部署 Webhook 前先部署 cert-manager。"
				}
			]
		},
		{
			"ID": "20221129014959-kj704ou",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20221129014959-kj704ou",
				"updated": "20221129014959"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "可以使用下面的命令来部署 cert-manager:"
				}
			]
		},
		{
			"ID": "20221129014959-zbl958b",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20221129014959-zbl958b",
				"updated": "20221129014959"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.8.0/cert\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20221129015016-l06mbot",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20221129015016-l06mbot",
				"updated": "20221129015022"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "更多 cert-manager 使用请参考 "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://cert-manager.io/docs/",
					"TextMarkTextContent": "cert-manager 文档"
				},
				{
					"Type": "NodeText",
					"Data": "。"
				}
			]
		},
		{
			"ID": "20221129015042-tx0d6w0",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20221129015042-tx0d6w0",
				"updated": "20221129015048"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2.2 安装 Webhook"
				}
			]
		},
		{
			"ID": "20221129015042-mset50s",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20221129015042-mset50s",
				"updated": "20221129015042"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "下载 Webhook 对应的 yaml 进行安装"
				}
			]
		},
		{
			"ID": "20221129015052-fsmvrku",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20221129015052-fsmvrku",
				"updated": "20221129015101"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "XA=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "# kubectl apply -f https://raw.githubusercontent.com/kubeovn/kube-ovn/release-1.10/yamls/webhook.yaml\ndeployment.apps/kube-ovn-webhook created\nservice/kube-ovn-webhook created\nvalidatingwebhookconfiguration.admissionregistration.k8s.io/kube-ovn-webhook created\ncertificate.cert-manager.io/kube-ovn-webhook-serving-cert created\nissuer.cert-manager.io/kube-ovn-webhook-selfsigned-issuer created\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20221129015118-ekh5935",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20221129015118-ekh5935",
				"updated": "20221129015125"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2.3 验证 Webhook 生效"
				}
			]
		},
		{
			"ID": "20221129015118-po5gs13",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20221129015118-po5gs13",
				"updated": "20221129015118"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "查看已运行 Pod，得到 Pod IP "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "code",
					"TextMarkTextContent": "10.16.0.15"
				},
				{
					"Type": "NodeText",
					"Data": "："
				}
			]
		},
		{
			"ID": "20221129015118-dl0hthn",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20221129015118-dl0hthn",
				"updated": "20221129015118"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "# kubectl get pod -o wide\nNAME                      READY   STATUS    RESTARTS   AGE     IP           NODE              NOMINATED NODE   READINESS GATES\nstatic-7584848b74-fw9dm   1/1     Running   0          2d13h   10.16.0.15   kube-ovn-worker   \u003cnone\u003e \n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20221129015118-wjf5bik",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20221129015118-wjf5bik",
				"updated": "20221129015118"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "编写 yaml 创建相同 IP 的 Pod："
				}
			]
		},
		{
			"ID": "20221129015118-09pit9l",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20221129015118-09pit9l",
				"updated": "20221129015200"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "apiVersion: v1\nkind: Pod\nmetadata:\n  annotations:\n    ovn.kubernetes.io/ip_address: 10.16.0.15\n    ovn.kubernetes.io/mac_address: 00:00:00:53:6B:B6\n  labels:\n    app: static\n  managedFields:\n  name: staticip-pod\n  namespace: default\nspec:\n  containers:\n  - image: nginx:alpine\n    imagePullPolicy: IfNotPresent\n    name: qatest\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20221129015118-p6szres",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20221129015118-p6szres",
				"updated": "20221129015118"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "使用以上 yaml 创建静态地址 Pod 的时候，提示 IP 地址冲突："
				}
			]
		},
		{
			"ID": "20221129015118-o2q9pzx",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20221129015118-o2q9pzx",
				"updated": "20221129015118"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "# kubectl apply -f pod-static.yaml\nError from server (annotation ip address 10.16.0.15 is conflict with ip crd static-75\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		}
	]
}