{
	"ID": "20240910134217-1lv2zvi",
	"Spec": "1",
	"Type": "NodeDocument",
	"Properties": {
		"id": "20240910134217-1lv2zvi",
		"scroll": "{\u0026quot;startId\u0026quot;:\u0026quot;20240910134217-w5iwmy3\u0026quot;,\u0026quot;endId\u0026quot;:\u0026quot;20240910134217-qsymwp1\u0026quot;,\u0026quot;scrollTop\u0026quot;:0,\u0026quot;focusId\u0026quot;:\u0026quot;20240910134217-zp6jo72\u0026quot;,\u0026quot;focusStart\u0026quot;:57,\u0026quot;focusEnd\u0026quot;:57}",
		"title": "探讨4层代理和7层代理行为以及如何获取真实客户端IP_socket4层代理和7层代理-CSDN博客",
		"updated": "20240910134217"
	},
	"Children": [
		{
			"ID": "20240910134217-w5iwmy3",
			"Type": "NodeThematicBreak",
			"Properties": {
				"id": "20240910134217-w5iwmy3",
				"updated": "20240910134217"
			}
		},
		{
			"ID": "20240910134217-ujukypk",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20240910134217-ujukypk",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"ID": "20240910134217-o3q8xx7",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20240910134217-o3q8xx7",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-zp6jo72",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-zp6jo72",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://blog.csdn.net/xq123joes/article/details/140179423",
									"TextMarkTextContent": "https://blog.csdn.net/xq123joes/article/details/140179423"
								}
							]
						}
					]
				},
				{
					"ID": "20240910134217-6h9dh7u",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20240910134217-6h9dh7u",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-mchhxis",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-mchhxis",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "文章浏览阅读974次，点赞19次，收藏15次。4层转发不会修改报文。在不修改HTTP报文前提下，前置补充代理信息, 格式: PROXY TCP 客户端IP 代理端IP 客户端端口 代理端端口。上述操作主要是完成: Nginx和Haproxy两款服务分别完成: 4层转发和7层代理。携带IP与不携带客户端IP配置上的区别和报文展示。7层代理会对报文进行重新封装，封装过程中可以通过增加XFF的header传递客户端IP。这是一个简单的HTTP服务，主要打印HTTP报文用于分析客户端IP。其实和nginx一样。_socket4层代理和7层代理"
								}
							]
						}
					]
				},
				{
					"ID": "20240910134217-8l87yl4",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20240910134217-8l87yl4",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-llk3wgd",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-llk3wgd",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "2024-09-10 13:42:17"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-icf8o27",
			"Type": "NodeThematicBreak",
			"Properties": {
				"id": "20240910134217-icf8o27",
				"updated": "20240910134217"
			}
		},
		{
			"ID": "20240910134217-w78y1gt",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20240910134217-w78y1gt",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "准备工作"
				}
			]
		},
		{
			"ID": "20240910134217-3a7x3ov",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-3a7x3ov",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "实验环境"
				}
			]
		},
		{
			"ID": "20240910134217-w3cjv19",
			"Type": "NodeTable",
			"TableAligns": [
				0,
				0
			],
			"Properties": {
				"colgroup": "|",
				"id": "20240910134217-w3cjv19",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTableHead",
					"Data": "thead",
					"Children": [
						{
							"Type": "NodeTableRow",
							"Data": "tr",
							"Children": [
								{
									"Type": "NodeTableCell",
									"Data": "th",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "IP"
										}
									]
								},
								{
									"Type": "NodeTableCell",
									"Data": "th",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "角色"
										}
									]
								}
							]
						}
					]
				},
				{
					"Type": "NodeTableRow",
					"Data": "tr",
					"Children": [
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "192.168.1.100"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "客户端请求IP"
								}
							]
						}
					]
				},
				{
					"Type": "NodeTableRow",
					"Data": "tr",
					"Children": [
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "192.168.1.100"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "python 启动的HTTP服务"
								}
							]
						}
					]
				},
				{
					"Type": "NodeTableRow",
					"Data": "tr",
					"Children": [
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "192.168.1.102"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "nginx服务"
								}
							]
						}
					]
				},
				{
					"Type": "NodeTableRow",
					"Data": "tr",
					"Children": [
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "192.168.1.103"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "haproxy 服务"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-bhfrz99",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-bhfrz99",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "HTTP服务"
				}
			]
		},
		{
			"ID": "20240910134217-umpjy02",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-umpjy02",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "这是一个简单的HTTP服务，主要打印"
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://so.csdn.net/so/search?q=HTTP%E6%8A%A5%E6%96%87\u0026spm=1001.2101.3001.7020",
					"TextMarkTextContent": "HTTP报文"
				},
				{
					"Type": "NodeText",
					"Data": "用于分析客户端IP"
				}
			]
		},
		{
			"ID": "20240910134217-tf8cux4",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-tf8cux4",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "cHl0aG9u"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "#!/usr/bin/env python\n# coding: utf-8\n\nimport socket\nfrom threading import Thread\n\n# 创建socket对象\nsock_srv = socket.socket()\n\n# 绑定IP和port\nsock_srv.bind(('0.0.0.0', 5001))\n\n# 开启服务\nsock_srv.listen()\n\n# 定义一个函数, 处理来自客户端链接的处理\ndef socket_deal(conn: socket.socket, address: tuple):\n\t# 通过socket获取客户端的IP; 这里的客户端IP其实指的是TCP报文中的原始IP和原始Port\n\t# 就是上一个发起TCP发起的地址 \n    print(address)\n\n    # 打印HTTP的报文\n    print(conn.recv(1024).decode())\n\n    # 不做特殊处理，所有的请求均返回Hello Word\n    template = \"\"\"\nHTTP/1.1 200 OK\nService: HTTP\nVersion: 1.1.2.2\n\n\u003ch1\u003ehello word\u003c/h1\u003e\n    \"\"\"\n    conn.send(template.encode())\n\n    # 关闭此次HTTP的请求\n    conn.close()\n\n\nwhile True:\n    # 接受Client的数据请求\n    conn, address = sock_srv.accept()\n    Thread(target=socket_deal, args=(conn, address)).start()\n\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-d83x4ia",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20240910134217-d83x4ia",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://so.csdn.net/so/search?q=Nginx\u0026spm=1001.2101.3001.7020",
					"TextMarkTextContent": "Nginx"
				},
				{
					"Type": "NodeText",
					"Data": "报文分析"
				}
			]
		},
		{
			"ID": "20240910134217-1433voa",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-1433voa",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "nginx 4层代理"
				}
			]
		},
		{
			"ID": "20240910134217-6yju9tf",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20240910134217-6yju9tf",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"ID": "20240910134217-1c4aa91",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20240910134217-1c4aa91",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-arr2rq5",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-arr2rq5",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "配置启动4层代理, 并请求 "
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "code",
									"TextMarkTextContent": "http://192.168.1.102"
								},
								{
									"Type": "NodeText",
									"Data": "​ 并观察 "
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "code",
									"TextMarkTextContent": "101"
								},
								{
									"Type": "NodeText",
									"Data": "​ 的请求信息"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-vyjn84u",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-vyjn84u",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "Y29uZmln"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "stream {\n\tserver {\n\t  listen 80 ;\n\t  proxy_pass 192.168.1.100:5001;  \t\t# Python的HTTP服务\n\t  # proxy_protocol on;\t\t\t\t\t# 可选性, 4层携带真实IP\n\t}\n}\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-gz3o5ak",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20240910134217-gz3o5ak",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"ID": "20240910134217-8mg5m04",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20240910134217-8mg5m04",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-7hsq0z8",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-7hsq0z8",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "客户端请求4层转发，默认不传递客户端IP。"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-aou3sql",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-aou3sql",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "c2hlbGw="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "# print(address), 可以从socket得到客户端IP\n('192.168.1.102', 52842)\n\n# 得到HTTP的报文信息如下\nGET / HTTP/1.1\nHost: 192.168.1.102\nConnection: keep-alive\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-oks2vfr",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20240910134217-oks2vfr",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"ID": "20240910134217-gfojrqb",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20240910134217-gfojrqb",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-cwpiqm1",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-cwpiqm1",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "客户端请求4层转发，要求传递客户端IP。"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-tke6kfn",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-tke6kfn",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "c2hlbGw="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "# print(address), 可以从socket得到客户端IP\n('192.168.1.102', 52848)\n\n# 得到HTTP的报文信息如下，多了一行PROXY。其余信息不变\nPROXY TCP4 192.168.1.100 192.168.1.102 55360 80\nGET / HTTP/1.1\nHost: 192.168.1.102\nConnection: keep-alive\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-tts8dqn",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-tts8dqn",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "nginx 7层代理"
				}
			]
		},
		{
			"ID": "20240910134217-mws22lk",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20240910134217-mws22lk",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"ID": "20240910134217-v029fcr",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20240910134217-v029fcr",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-tivrlah",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-tivrlah",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "配置文件"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-s6ed2j1",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-s6ed2j1",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "Y29uZg=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "server {                                                                         \n    listen       80;                                                             \n    server_name  localhost;                                                      \n                                                                                 \n                                                                                 \n    location / {                                                                 \n        proxy_pass http://192.168.1.100:8000/;                                                                       \n        # proxy_set_header X-Forwarded-For $remote_addr;   # nginx 去掉注释请求携带客户端真实IP                              \n    }                                                                            \n                                                                                 \n}\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-znzxx59",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20240910134217-znzxx59",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"ID": "20240910134217-ceu5z4e",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20240910134217-ceu5z4e",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-q3ijr9r",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-q3ijr9r",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "客户端请求7层代理，默认不传递客户端IP真实IP。"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-8yrs1za",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-8yrs1za",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "bG9n"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "# print(address), 可以从socket得到客户端IP\n('192.168.1.102', 52854)\n\n# 得到HTTP的报文信息如下.\nGET / HTTP/1.0\nHost: 192.168.1.100:5001\nConnection: close\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-lsuf4d0",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20240910134217-lsuf4d0",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"ID": "20240910134217-rujzrwa",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20240910134217-rujzrwa",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-8hhk0mv",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-8hhk0mv",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "客户端请求7层，要求传递客户端IP真实IP。"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-m1gkbzy",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-m1gkbzy",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "bG9n"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "# print(address), 可以从socket得到客户端IP\n('192.168.1.102', 52858)\n\n# 得到HTTP的报文信息如下，多了一行PROXY。其余信息不变\nGET / HTTP/1.0\nHost: 192.168.1.100:5001\nConnection: close\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nX-Forwarded-For: 192.168.1.100\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-dccswxv",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-dccswxv",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "分析NGINX获取客户端IP方法"
				}
			]
		},
		{
			"ID": "20240910134217-079a0c7",
			"Type": "NodeTable",
			"TableAligns": [
				0,
				0,
				0,
				0
			],
			"Properties": {
				"colgroup": "|||",
				"id": "20240910134217-079a0c7",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTableHead",
					"Data": "thead",
					"Children": [
						{
							"Type": "NodeTableRow",
							"Data": "tr",
							"Children": [
								{
									"Type": "NodeTableCell",
									"Data": "th",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "方式"
										}
									]
								},
								{
									"Type": "NodeTableCell",
									"Data": "th",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "修改header信息"
										}
									]
								},
								{
									"Type": "NodeTableCell",
									"Data": "th",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "是否修改原始报文"
										}
									]
								},
								{
									"Type": "NodeTableCell",
									"Data": "th",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "获取客户端IP方式"
										}
									]
								}
							]
						}
					]
				},
				{
					"Type": "NodeTableRow",
					"Data": "tr",
					"Children": [
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "4层转发不带客户端IP"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "不修改"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "不修改"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "服务端可以获取上一层发起请求的socket 源IP, 但不是客户端真实IP"
								}
							]
						}
					]
				},
				{
					"Type": "NodeTableRow",
					"Data": "tr",
					"Children": [
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "4层转发携带客户端IP"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "不修改"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "原始报文前增加PROXY格式内容"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "通过PROXY内容可以获取客户端IP"
								}
							]
						}
					]
				},
				{
					"Type": "NodeTableRow",
					"Data": "tr",
					"Children": [
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "7层转发不带客户端IP"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "不修改"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "nginx重新封装HTTP报文"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "服务端 socket 获取"
								}
							]
						}
					]
				},
				{
					"Type": "NodeTableRow",
					"Data": "tr",
					"Children": [
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "7层转发携带客户端IP"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "nginx 通过增加header信息传递客户端IP"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "nginx重新封装HTTP报文"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "通过nginx封装的报文获取XFF"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-qj5xvp4",
			"Type": "NodeList",
			"ListData": {
				"Typ": 1
			},
			"Properties": {
				"id": "20240910134217-qj5xvp4",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"ID": "20240910134217-pig6y33",
					"Type": "NodeListItem",
					"ListData": {
						"Typ": 1,
						"Delimiter": 46,
						"Marker": "MS4=",
						"Num": 1
					},
					"Properties": {
						"id": "20240910134217-pig6y33",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-75fvj4l",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-75fvj4l",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "7层代理会对报文进行重新封装，封装过程中可以通过增加XFF的header传递"
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://so.csdn.net/so/search?q=%E5%AE%A2%E6%88%B7%E7%AB%AF\u0026spm=1001.2101.3001.7020",
									"TextMarkTextContent": "客户端"
								},
								{
									"Type": "NodeText",
									"Data": "IP。"
								}
							]
						}
					]
				},
				{
					"ID": "20240910134217-omnh819",
					"Type": "NodeListItem",
					"ListData": {
						"Typ": 1,
						"Delimiter": 46,
						"Marker": "Mi4=",
						"Num": 2
					},
					"Properties": {
						"id": "20240910134217-omnh819",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-kqbqu0n",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-kqbqu0n",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "4层转发不会修改报文。在不修改HTTP报文前提下，前置补充代理信息, 格式: PROXY TCP 客户端IP 代理端IP 客户端端口 代理端端口"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-vgfnzv8",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20240910134217-vgfnzv8",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "Haproxy 代理分析"
				}
			]
		},
		{
			"ID": "20240910134217-76xzddk",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-76xzddk",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "Haproxy 4层代理"
				}
			]
		},
		{
			"ID": "20240910134217-zwqmwxb",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20240910134217-zwqmwxb",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"ID": "20240910134217-vtjz8ld",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20240910134217-vtjz8ld",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-uigiu66",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-uigiu66",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "配置"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-5x53clh",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-5x53clh",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "Y29uZg=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "defaults\n    mode                    tcp\n\nfrontend  main *:80\n    default_backend             app\n\nbackend app\n    balance     roundrobin\n    server  app1 192.168.1.100:5001 check # 不携带真实IP\n    # server  app1 192.168.1.100:5001 send-proxy check  # 携带真实IP\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-9qupv3n",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20240910134217-9qupv3n",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"ID": "20240910134217-ceb8je4",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20240910134217-ceb8je4",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-tpghjtn",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-tpghjtn",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "客户端请求4层转发，默认不要求传递客户端IP"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-ta5zi0m",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-ta5zi0m",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "bG9n"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "# print(address) 获取客户端的address信息\n('192.168.1.103', 56790)\n\n# 这个信息和NGINX 4层信息一样\nGET / HTTP/1.1\nHost: 192.168.1.103\nConnection: keep-alive\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-srse3tt",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20240910134217-srse3tt",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"ID": "20240910134217-qu3niaw",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20240910134217-qu3niaw",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-4ot1kcp",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-4ot1kcp",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "客户端请求4层转发，要求传递客户端IP"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-rqajyta",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-rqajyta",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "bG9n"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "# print(address) 获取客户端的address信息\n('192.168.1.103', 58410)\n\n# 与Nginx 4层带真实IP一样, 报文之前增加了PROXY信息\nPROXY TCP4 192.168.1.100 192.168.1.103 57871 80\nGET / HTTP/1.1\nHost: 192.168.1.103\nConnection: keep-alive\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\n\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-car6yh5",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-car6yh5",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "Haproxy 7层代理"
				}
			]
		},
		{
			"ID": "20240910134217-1sks083",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20240910134217-1sks083",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"ID": "20240910134217-5f3dg3u",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20240910134217-5f3dg3u",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-0si6wfg",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-0si6wfg",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "配置"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-0ns3qq1",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-0ns3qq1",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "Y29uZg=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "defaults\n    mode                    http\n    option forwardfor       except 127.0.0.0/8   # 默认携带客户端IP，\n\nfrontend  main *:80\n    default_backend             app\n\nbackend app\n    balance     roundrobin\n    server  app1 192.168.1.100:5001 check \n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-prxsa16",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20240910134217-prxsa16",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"ID": "20240910134217-gii4f9f",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20240910134217-gii4f9f",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-982jxex",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-982jxex",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "客户端请求7层代理，默认传递客户端IP"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-sar12m5",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-sar12m5",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "bG9n"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "# print(address) 获取客户端的address信息\n('192.168.1.103', 53178)\n\n# 与Nginx 7层带客户端IP一样, 报文包含X-Forwarded-For\nGET /favicon.ico HTTP/1.1\nHost: 192.168.1.103\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36\nAccept: image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8\nReferer: http://192.168.1.103/\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nX-Forwarded-For: 192.168.1.100\nConnection: close\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-x7wflzq",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20240910134217-x7wflzq",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"ID": "20240910134217-00sd8bf",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20240910134217-00sd8bf",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-vkr531s",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-vkr531s",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "客户端请求7层代理，注释不传递客户端IP"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-oa3h47r",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-oa3h47r",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "bG9n"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "# print(address) 获取客户端的address信息\n('192.168.1.103', 53576)\n\n# 与Nginx 7层不传递客户端IP一样, 报文包含没有X-Forwarded-For\nGET / HTTP/1.1\nHost: 192.168.1.103\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-p4sdoyg",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-p4sdoyg",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "分析Haproxy获取客户端IP方法"
				}
			]
		},
		{
			"ID": "20240910134217-5yk7mb0",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-5yk7mb0",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "其实和nginx一样"
				}
			]
		},
		{
			"ID": "20240910134217-xidsgcd",
			"Type": "NodeTable",
			"TableAligns": [
				0,
				0,
				0,
				0
			],
			"Properties": {
				"colgroup": "|||",
				"id": "20240910134217-xidsgcd",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTableHead",
					"Data": "thead",
					"Children": [
						{
							"Type": "NodeTableRow",
							"Data": "tr",
							"Children": [
								{
									"Type": "NodeTableCell",
									"Data": "th",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "方式"
										}
									]
								},
								{
									"Type": "NodeTableCell",
									"Data": "th",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "修改header信息"
										}
									]
								},
								{
									"Type": "NodeTableCell",
									"Data": "th",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "是否修改原始报文"
										}
									]
								},
								{
									"Type": "NodeTableCell",
									"Data": "th",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "获取客户端IP方式"
										}
									]
								}
							]
						}
					]
				},
				{
					"Type": "NodeTableRow",
					"Data": "tr",
					"Children": [
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "4层转发不带客户端IP"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "不修改"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "不修改"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "服务端可以获取上一层发起请求的socket 源IP, 但不是客户端真实IP"
								}
							]
						}
					]
				},
				{
					"Type": "NodeTableRow",
					"Data": "tr",
					"Children": [
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "4层转发携带客户端IP"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "不修改"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "原始报文前增加PROXY格式内容"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "通过PROXY内容可以获取客户端IP"
								}
							]
						}
					]
				},
				{
					"Type": "NodeTableRow",
					"Data": "tr",
					"Children": [
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "7层转发不带客户端IP"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "不修改"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "nginx重新封装HTTP报文"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "服务端 socket 获取"
								}
							]
						}
					]
				},
				{
					"Type": "NodeTableRow",
					"Data": "tr",
					"Children": [
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "7层转发携带客户端IP"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "nginx 通过增加header信息传递客户端IP"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "nginx重新封装HTTP报文"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "通过nginx封装的报文获取XFF"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-1vudlnu",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20240910134217-1vudlnu",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "案例小结"
				}
			]
		},
		{
			"ID": "20240910134217-tzjd9oh",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-tzjd9oh",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "上述操作主要是完成: Nginx和Haproxy两款服务分别完成: 4层转发和7层代理。 携带IP与不携带客户端IP配置上的区别和报文展示"
				}
			]
		},
		{
			"ID": "20240910134217-xy3r3vf",
			"Type": "NodeTable",
			"TableAligns": [
				0,
				0,
				0
			],
			"Properties": {
				"colgroup": "||",
				"id": "20240910134217-xy3r3vf",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTableHead",
					"Data": "thead",
					"Children": [
						{
							"Type": "NodeTableRow",
							"Data": "tr",
							"Children": [
								{
									"Type": "NodeTableCell",
									"Data": "th",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "转发方式"
										}
									]
								},
								{
									"Type": "NodeTableCell",
									"Data": "th",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "传递方式"
										}
									]
								},
								{
									"Type": "NodeTableCell",
									"Data": "th",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "特点"
										}
									]
								}
							]
						}
					]
				},
				{
					"Type": "NodeTableRow",
					"Data": "tr",
					"Children": [
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "7层代理"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "增加HTTP报文的header信息X-Forwarded-For, 进行传递客户端IP"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "在原始报文进行修改"
								}
							]
						}
					]
				},
				{
					"Type": "NodeTableRow",
					"Data": "tr",
					"Children": [
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "4层代理"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "在HTTP报文前方附加一层PROXY信息, 进行传递客户端IP"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "不修改原始报文，在HTTP报文前方附加数据"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-77pqh4v",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-77pqh4v",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "提前了解一下: NGINX中参数设定protocol。开启后可以处理 “在HTTP报文前方附加数据” 混淆的HTTP报文结构"
				}
			]
		},
		{
			"ID": "20240910134217-qaqf57c",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-qaqf57c",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "​"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "在这里插入图片描述"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "assets/5ee2392ec76b4c99b96c1ef4e785c2e3-20240910134217-yw0sl7h.jpeg"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20240910134217-oecsjt1",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-oecsjt1",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "附伪代码获取客户端IP"
				}
			]
		},
		{
			"ID": "20240910134217-9zwvvwt",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-9zwvvwt",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "cHl0aG9u"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "#!/usr/bin/env python\n# coding: utf-8\nimport socket\nfrom threading import Thread\n\n# 创建socket对象\nsock_srv = socket.socket()\n\n# 绑定IP和port\nsock_srv.bind(('0.0.0.0', 5001))\n\n# 开启服务\nsock_srv.listen()\n\n\n# 简单的Response结构\ndef response(content, status, msg, conn):\n    template = \"\"\"\nHTTP/1.1 %d %s\nService: HTTP\nVersion: 1.1.2.2\nContent-Type: text/html; charset=UTF-8\nConnection: close\n\n%s  \n    \"\"\" % (status, msg, content)\n    return conn.send(template.encode())\n\n\n# 定义一个函数, 处理来自客户端链接的处理\ndef socket_deal(conn: socket.socket, address: tuple):\n    try:\n        # 通过socket获取客户端的IP; 这里的客户端IP其实指的是TCP报文中的原始IP和原始Port\n        # 就是上一个发起TCP发起的地址\n        _client_ip, _client_port = address\n        data = conn.recv(1024).decode()\n\n        # 打印HTTP的报文\n        _data_lines = data.splitlines()\n\n        # 代理模式\n        _proxy_type = \"可能HTTP代理\"\n\n        # header 信息收集\n        extend_data = [\"header信息\", ]\n        for line in _data_lines:\n\n            # 如果4层传递客户端IP，会得到如下信息。\n            if line.startswith('PROXY'):\n                # PROXY TCP4 192.168.1.100 192.168.1.102 55360 80\n                _, protocol, _c_ip, _p_ip, _c_port, _p_port = line.split()\n                if protocol != 'TCP4':\n                    response(\"PROXY ERROR\", 500, \"PROXY_ERROR\", conn)\n                else:\n                    _proxy_type = \"TCP代理\"\n                    _client_ip = _c_ip\n                    # 有时候报文只收到PROXY信息, 就需要第二次接收报文信息\n                    if len(_data_lines) == 1:\n                        socket_deal(conn, (_c_ip, _c_port))\n                        return\n                    # 如果一次性收完报文信息则继续处理\n                    else:\n                        continue\n\n            if \":\" not in line:\n                # 不是K:V 形式，那不是header。 可能是post数据, 也可能是HTTP协议。 此处忽略\n                continue\n\n            # 拿到header信息\n            header_key, header_value = [item.strip() for item in line.split(\":\", 1)]\n            if header_key == 'X-Forwarded-For':\n                _client_ip = header_value\n\n            # header 信息入库\n            extend_data.append(\":\".join((header_key, header_value)))\n\n        content = [\"真实的客户端IP可能是\" + _client_ip, \"\u003cbr /\u003e\"]\n        content.extend(extend_data)\n        response(\"\u003cbr /\u003e\".join(content), 200, 'ok', conn)\n      \n    except Exception as e:\n        print(e)\n    finally:\n        # 关闭此次HTTP的请求\n        conn.close()\n\n\nwhile True:\n    # 接受Client的数据请求\n    conn, address = sock_srv.accept()\n    Thread(target=socket_deal, args=(conn, address)).start()\n\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-lgz6fls",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20240910134217-lgz6fls",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "实践: NGINX与HAProxy结合使用。"
				}
			]
		},
		{
			"ID": "20240910134217-f7w65qj",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-f7w65qj",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "准备环境"
				}
			]
		},
		{
			"ID": "20240910134217-jlg89hh",
			"Type": "NodeTable",
			"TableAligns": [
				0,
				0,
				0,
				0
			],
			"Properties": {
				"colgroup": "|||",
				"id": "20240910134217-jlg89hh",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTableHead",
					"Data": "thead",
					"Children": [
						{
							"Type": "NodeTableRow",
							"Data": "tr",
							"Children": [
								{
									"Type": "NodeTableCell",
									"Data": "th",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "IP"
										}
									]
								},
								{
									"Type": "NodeTableCell",
									"Data": "th",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "角色"
										}
									]
								},
								{
									"Type": "NodeTableCell",
									"Data": "th",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "标记"
										}
									]
								},
								{
									"Type": "NodeTableCell",
									"Data": "th",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "说明"
										}
									]
								}
							]
						}
					]
				},
				{
					"Type": "NodeTableRow",
					"Data": "tr",
					"Children": [
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "192.168.1.100"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "客户端请求IP"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "client"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "浏览器请求4层转发到后端HTTP服务"
								}
							]
						}
					]
				},
				{
					"Type": "NodeTableRow",
					"Data": "tr",
					"Children": [
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "192.168.1.102"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "NGINX实现提供4层转发"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "NGINX-PROXY"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "转发到104服务器"
								}
							]
						}
					]
				},
				{
					"Type": "NodeTableRow",
					"Data": "tr",
					"Children": [
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "192.168.1.103"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "Haproxy提供4层转发"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "HAProxy"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "4层转发到102的7层"
								}
							]
						}
					]
				},
				{
					"Type": "NodeTableRow",
					"Data": "tr",
					"Children": [
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "192.168.1.104"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "NGINX 7层服务"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "NGINX-HTTP"
								}
							]
						},
						{
							"Type": "NodeTableCell",
							"Data": "td",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "代表HTTP服务器。直接返回，并观察日志"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-2smbowu",
			"Type": "NodeList",
			"ListData": {
				"Typ": 1
			},
			"Properties": {
				"id": "20240910134217-2smbowu",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"ID": "20240910134217-lhag5sr",
					"Type": "NodeListItem",
					"ListData": {
						"Typ": 1,
						"Delimiter": 46,
						"Marker": "MS4=",
						"Num": 1
					},
					"Properties": {
						"id": "20240910134217-lhag5sr",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-v4apq70",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-v4apq70",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "启动一台NGINX HTTP服务器，扮演正常访问的网站。 代号NGINX-HTTP"
								}
							]
						}
					]
				},
				{
					"ID": "20240910134217-lnj1n1t",
					"Type": "NodeListItem",
					"ListData": {
						"Typ": 1,
						"Delimiter": 46,
						"Marker": "Mi4=",
						"Num": 2
					},
					"Properties": {
						"id": "20240910134217-lnj1n1t",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-nvvpvp8",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-nvvpvp8",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "另启动一台NGINX服务器，实现四层转发功能到NGINX HTTP服务器，代号NGINX-PROXY"
								}
							]
						}
					]
				},
				{
					"ID": "20240910134217-kr8zmmj",
					"Type": "NodeListItem",
					"ListData": {
						"Typ": 1,
						"Delimiter": 46,
						"Marker": "My4=",
						"Num": 3
					},
					"Properties": {
						"id": "20240910134217-kr8zmmj",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-j9icxmb",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-j9icxmb",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "启动一台HAProxy服务器，实现四层转发功能到NGINX HTTP服务器，代号HAProxy"
								}
							]
						}
					]
				},
				{
					"ID": "20240910134217-qh77gwd",
					"Type": "NodeListItem",
					"ListData": {
						"Typ": 1,
						"Delimiter": 46,
						"Marker": "NC4=",
						"Num": 4
					},
					"Properties": {
						"id": "20240910134217-qh77gwd",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-jwk3lgq",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-jwk3lgq",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "在客户端分别访问NGINX-PROXY和HAProxy, 并采集NGINX-HTTP的日志"
								}
							]
						}
					]
				},
				{
					"ID": "20240910134217-sfsgy8n",
					"Type": "NodeListItem",
					"ListData": {
						"Typ": 1,
						"Delimiter": 46,
						"Marker": "NS4=",
						"Num": 5
					},
					"Properties": {
						"id": "20240910134217-sfsgy8n",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-2xd9s4p",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-2xd9s4p",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "在NGINX-PROXY和HAProxy交叉请求CURL，并携带Header信息: X-FORWARDED-FOR, 并采集NGINX-HTTP的日志"
								}
							]
						}
					]
				},
				{
					"ID": "20240910134217-7xv50lf",
					"Type": "NodeListItem",
					"ListData": {
						"Typ": 1,
						"Delimiter": 46,
						"Marker": "Ni4=",
						"Num": 6
					},
					"Properties": {
						"id": "20240910134217-7xv50lf",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-tcegijv",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-tcegijv",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "PROXY-PROTOCOL, 是四层转发开启携带真实IP补充协议，即: 在HTTP报文前方附加的数据。 "
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://nginx.org/en/docs/http/ngx_http_core_module.html#listen",
									"TextMarkTextContent": "参考文档"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-n9davbo",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-n9davbo",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "NGINX-HTTP服务器"
				}
			]
		},
		{
			"ID": "20240910134217-0iccowv",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20240910134217-0iccowv",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"ID": "20240910134217-km5ls1k",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20240910134217-km5ls1k",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-y6uwces",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-y6uwces",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "HTTP服务主要配置"
								}
							]
						}
					]
				},
				{
					"ID": "20240910134217-5f9eufn",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20240910134217-5f9eufn",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-hn6l8sr",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-hn6l8sr",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "因为4层转发携带了真实IP后, NGINX收到的不再是一个纯粹的HTTP报文。 所以需要在NGINX服务开启如下设置。 "
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://nginx.org/en/docs/http/ngx_http_core_module.html#listen",
									"TextMarkTextContent": "参考文档"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20240910134217-da5qf8w",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-da5qf8w",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "Y29uZg=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "\nhttp {\n\t# r:访问IP, 也就是代理端IP。 \n\t# P: PROXY-PROTOCOL的IP，也就是4层转发携带的补充报文的IP，也就是客户端IP。 \n\t# xff: 藏在Header中的X-Forwarded-For的IP。\n\tlog_format  proxy_protocol_log  'r: $remote_addr p: $proxy_protocol_addr xff: $http_x_forwarded_for';\n\n \tserver {\n \t\taccess_log logs/proxy_protocol_access.log proxy_protocol_log;\t# 观察IP: 访问IP，代理IP，XFF\n \t\terror_log logs/proxy_protocol_error.log\n\n\t\tlisten       80 ;               \t\t# 接收HTTP报文走80端口                                      \n\t \tlisten       8000 proxy_protocol;     \t# PROXY PROTOCOL 走8000端口，PROTOCOL 是通过四层转发获取真实IP的补充协议             \n\t \tserver_name  localhost;   \n\n\t \tlocation / {\n\t \t\troot html;\n\t \t\tindex index.html;\n\t \t}\n\t}\n}\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-a8s2vx9",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-a8s2vx9",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "NGINX-PROXY服务器"
				}
			]
		},
		{
			"ID": "20240910134217-7ugsn74",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-7ugsn74",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "关键配置"
				}
			]
		},
		{
			"ID": "20240910134217-j1itfe0",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-j1itfe0",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "Y29uZg=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "stream {\n\tserver {\n\t  listen 80 ;\n\t  proxy_protocol on; \t# 需要开启使用PROXY PROTOCOL协议。\n\t  proxy_pass 192.168.1.104:8000;\n\t}\n}\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-zd3o8dz",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-zd3o8dz",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "浏览器访问, NGINX-HTTP(192.168.1.104)输出日志信息"
				}
			]
		},
		{
			"ID": "20240910134217-xlvlp7l",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-xlvlp7l",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "c2hlbGw="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "tail logs/proxy_protocol_access.log\nr: 192.168.1.102 p: 192.168.1.100 xff: -\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-xiz6tkm",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-xiz6tkm",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "CURL访问，NGINX-HTTP(192.168.1.104)输出日志信息"
				}
			]
		},
		{
			"ID": "20240910134217-n0mffq8",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-n0mffq8",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "c2hlbGw="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "tail logs/proxy_protocol_access.log\nr: 192.168.1.102 p: 192.168.1.103 xff: 192.168.1.199\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-ahf9tfk",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-ahf9tfk",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "HAProxy服务器"
				}
			]
		},
		{
			"ID": "20240910134217-vqbloo3",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-vqbloo3",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "关键配置"
				}
			]
		},
		{
			"ID": "20240910134217-7ca5w8x",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-7ca5w8x",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "Y29uZg=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "defaults\n    mode  tcp\n\nbackend app\n    balance     roundrobin\n    server  app1 192.168.1.104:8000 send-proxy  \t# send-proxy 开启支持PROXY-PROTOCOL\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-5xkg3of",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-5xkg3of",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "浏览器访问, NGINX-HTTP(192.168.1.104)输出日志信息"
				}
			]
		},
		{
			"ID": "20240910134217-0wxn11e",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-0wxn11e",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "c2hlbGw="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "tail -f logs/proxy_protocol_access.log\nr: 192.168.1.103 p: 192.168.1.100 xff: -\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-g1g4i25",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-g1g4i25",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "CURL访问，NGINX-HTTP(192.168.1.104)输出日志信息"
				}
			]
		},
		{
			"ID": "20240910134217-3js7xrc",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20240910134217-3js7xrc",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "c2hlbGw="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "tail -f logs/proxy_protocol_access.log\nr: 192.168.1.103 p: 192.168.1.102 xff: 192.168.1.199\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20240910134217-4ms1z2f",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-4ms1z2f",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "再次小结"
				}
			]
		},
		{
			"ID": "20240910134217-e1fg3jb",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20240910134217-e1fg3jb",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "我们尝试结合常见配置结构进行验证。 可以初步发现"
				}
			]
		},
		{
			"ID": "20240910134217-qsymwp1",
			"Type": "NodeList",
			"ListData": {
				"Typ": 1
			},
			"Properties": {
				"id": "20240910134217-qsymwp1",
				"updated": "20240910134217"
			},
			"Children": [
				{
					"ID": "20240910134217-vztzbld",
					"Type": "NodeListItem",
					"ListData": {
						"Typ": 1,
						"Delimiter": 46,
						"Marker": "MS4=",
						"Num": 1
					},
					"Properties": {
						"id": "20240910134217-vztzbld",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-aftcr3r",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-aftcr3r",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "4层转发携带客户端IP是需要使用PROPXY-PROTOCOL协议支持。客户端IP会补充在这个协议内"
								}
							]
						}
					]
				},
				{
					"ID": "20240910134217-v2i5kbk",
					"Type": "NodeListItem",
					"ListData": {
						"Typ": 1,
						"Delimiter": 46,
						"Marker": "Mi4=",
						"Num": 2
					},
					"Properties": {
						"id": "20240910134217-v2i5kbk",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-rrhtk96",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-rrhtk96",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "作为4层转发端，因为4层转发不修改报文，所以在HTTP报文前添加PROPXY-PROTOCOL信息。"
								}
							]
						},
						{
							"ID": "20240910134217-ns22n24",
							"Type": "NodeList",
							"ListData": {},
							"Properties": {
								"id": "20240910134217-ns22n24",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"ID": "20240910134217-yrjh3yt",
									"Type": "NodeListItem",
									"ListData": {
										"BulletChar": 42,
										"Marker": "Kg=="
									},
									"Properties": {
										"id": "20240910134217-yrjh3yt",
										"updated": "20240910134217"
									},
									"Children": [
										{
											"ID": "20240910134217-12kr7ii",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20240910134217-12kr7ii",
												"updated": "20240910134217"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "4层转发服务器需要开启 protocol 支持发送PROXY-PROTOCOL+HTTP的混淆报文结构"
												}
											]
										}
									]
								},
								{
									"ID": "20240910134217-2uu5ub8",
									"Type": "NodeListItem",
									"ListData": {
										"BulletChar": 42,
										"Marker": "Kg=="
									},
									"Properties": {
										"id": "20240910134217-2uu5ub8",
										"updated": "20240910134217"
									},
									"Children": [
										{
											"ID": "20240910134217-p7x4kn7",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20240910134217-p7x4kn7",
												"updated": "20240910134217"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "4层目标服务器需要开启 protocol 支持接收PROXY-PROTOCOL+HTTP的混淆报文结构"
												}
											]
										}
									]
								}
							]
						}
					]
				},
				{
					"ID": "20240910134217-6w9l2nu",
					"Type": "NodeListItem",
					"ListData": {
						"Typ": 1,
						"Delimiter": 46,
						"Marker": "My4=",
						"Num": 3
					},
					"Properties": {
						"id": "20240910134217-6w9l2nu",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-p7uouob",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-p7uouob",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "使用补充PROXY-PROTOCL后，HTTP的报文不在是一个纯粹的报文结构，所以作为服务网端NGINX开启了两种模式"
								}
							]
						},
						{
							"ID": "20240910134217-77h0cef",
							"Type": "NodeList",
							"ListData": {},
							"Properties": {
								"id": "20240910134217-77h0cef",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"ID": "20240910134217-lcwhsci",
									"Type": "NodeListItem",
									"ListData": {
										"BulletChar": 42,
										"Marker": "Kg=="
									},
									"Properties": {
										"id": "20240910134217-lcwhsci",
										"updated": "20240910134217"
									},
									"Children": [
										{
											"ID": "20240910134217-1pgznk3",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20240910134217-1pgznk3",
												"updated": "20240910134217"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "listen 80; 支持处理普通HTTP请求，"
												}
											]
										}
									]
								},
								{
									"ID": "20240910134217-x3mctjz",
									"Type": "NodeListItem",
									"ListData": {
										"BulletChar": 42,
										"Marker": "Kg=="
									},
									"Properties": {
										"id": "20240910134217-x3mctjz",
										"updated": "20240910134217"
									},
									"Children": [
										{
											"ID": "20240910134217-kkmbypi",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20240910134217-kkmbypi",
												"updated": "20240910134217"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "listen 80 protocol; 支持处理PROXY-PROTOCOL + HTTP报文的形式。这也是四层代理携带IP的特有形式"
												}
											]
										}
									]
								}
							]
						}
					]
				},
				{
					"ID": "20240910134217-5ekei7i",
					"Type": "NodeListItem",
					"ListData": {
						"Typ": 1,
						"Delimiter": 46,
						"Marker": "NC4=",
						"Num": 4
					},
					"Properties": {
						"id": "20240910134217-5ekei7i",
						"updated": "20240910134217"
					},
					"Children": [
						{
							"ID": "20240910134217-ijz5mt3",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20240910134217-ijz5mt3",
								"updated": "20240910134217"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "在选择HTTP服务器时，需要考虑HTTP服务是否支持PROXY-PROTOCOL。"
								}
							]
						}
					]
				}
			]
		}
	]
}