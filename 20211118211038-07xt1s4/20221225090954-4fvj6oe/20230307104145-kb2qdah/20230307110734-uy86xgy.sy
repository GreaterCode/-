{
	"ID": "20230307110734-uy86xgy",
	"Spec": "1",
	"Type": "NodeDocument",
	"Properties": {
		"id": "20230307110734-uy86xgy",
		"title": "节点内存碎片化排障",
		"updated": "20230307112816"
	},
	"Children": [
		{
			"ID": "20230307110734-40dli5i",
			"Type": "NodeHeading",
			"HeadingLevel": 1,
			"Properties": {
				"id": "20230307110734-40dli5i",
				"updated": "20230307110833"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "1. 内存页分配失败，内核日志将会出现以下报错"
				}
			]
		},
		{
			"ID": "20230307110805-ulknvfh",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230307110805-ulknvfh",
				"updated": "20230307112521"
			},
			"Children": [
				{
					"ID": "20230307110811-et73yt5",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307110811-et73yt5",
						"updated": "20230307112521"
					},
					"Children": [
						{
							"ID": "20230307110811-c2n59qh",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307110811-c2n59qh",
								"updated": "20230307110813"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "现象"
								}
							]
						},
						{
							"ID": "20230307110813-jxhz4yf",
							"Type": "NodeCodeBlock",
							"IsFencedCodeBlock": true,
							"Properties": {
								"id": "20230307110813-jxhz4yf",
								"updated": "20230307110826"
							},
							"Children": [
								{
									"Type": "NodeCodeBlockFenceOpenMarker",
									"Data": "```"
								},
								{
									"Type": "NodeCodeBlockFenceInfoMarker",
									"CodeBlockInfo": "XA=="
								},
								{
									"Type": "NodeCodeBlockCode",
									"Data": "mysqld: page allocation failure. order:4, mode:0x10c0d0\n"
								},
								{
									"Type": "NodeCodeBlockFenceCloseMarker",
									"Data": "```"
								}
							]
						},
						{
							"ID": "20230307111230-uz151i3",
							"Type": "NodeList",
							"ListData": {},
							"Properties": {
								"id": "20230307111230-uz151i3",
								"updated": "20230307111449"
							},
							"Children": [
								{
									"ID": "20230307111256-yiyeiuz",
									"Type": "NodeListItem",
									"ListData": {
										"BulletChar": 42,
										"Marker": "Kg=="
									},
									"Properties": {
										"id": "20230307111256-yiyeiuz"
									},
									"Children": [
										{
											"ID": "20230307111256-ldh2mbx",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20230307111256-ldh2mbx"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "mysqld：为被分配内存的程序。"
												}
											]
										}
									]
								},
								{
									"ID": "20230307111258-vn0p1ak",
									"Type": "NodeListItem",
									"ListData": {
										"BulletChar": 42,
										"Marker": "Kg=="
									},
									"Properties": {
										"id": "20230307111258-vn0p1ak",
										"updated": "20230307111449"
									},
									"Children": [
										{
											"ID": "20230307111258-nftmabb",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20230307111258-nftmabb",
												"updated": "20230307111449"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "order：表示需要分配连续页的数量（2"
												},
												{
													"Type": "NodeTextMark",
													"TextMarkType": "sup",
													"TextMarkTextContent": "order  ）"
												},
												{
													"Type": "NodeText",
													"Data": "，本例中4则表示  2^4 = 16 个连续的页。"
												}
											]
										}
									]
								}
							]
						},
						{
							"ID": "20230307111243-1w29w96",
							"Type": "NodeList",
							"ListData": {},
							"Properties": {
								"id": "20230307111243-1w29w96",
								"updated": "20230307112521"
							},
							"Children": [
								{
									"ID": "20230307111736-bkoimmw",
									"Type": "NodeListItem",
									"ListData": {
										"BulletChar": 42,
										"Marker": "Kg=="
									},
									"Properties": {
										"id": "20230307111736-bkoimmw",
										"updated": "20230307112521"
									},
									"Children": [
										{
											"ID": "20230307111736-4k4pmug",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20230307111736-4k4pmug",
												"updated": "20230307112509"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "mode：内存分配模式的标识，在内核源码文件"
												},
												{
													"Type": "NodeTextMark",
													"TextMarkType": "code",
													"TextMarkTextContent": "include/linux/gfp.h"
												},
												{
													"Type": "NodeText",
													"Data": "中定义，通常是多个标识项与运算的结果。不同版本内核有一定区别。"
												}
											]
										},
										{
											"ID": "20230307112516-051505z",
											"Type": "NodeList",
											"ListData": {},
											"Properties": {
												"id": "20230307112516-051505z",
												"updated": "20230307112521"
											},
											"Children": [
												{
													"ID": "20230307112514-56q3bfv",
													"Type": "NodeListItem",
													"ListData": {
														"BulletChar": 42,
														"Marker": "Kg=="
													},
													"Properties": {
														"id": "20230307112514-56q3bfv"
													},
													"Children": [
														{
															"ID": "20230307112514-651x3vt",
															"Type": "NodeParagraph",
															"Properties": {
																"id": "20230307112514-651x3vt"
															},
															"Children": [
																{
																	"Type": "NodeText",
																	"Data": "当 order 值为0时，说明系统已经完全没有可用内存。"
																}
															]
														}
													]
												},
												{
													"ID": "20230307112520-xft3os6",
													"Type": "NodeListItem",
													"ListData": {
														"BulletChar": 42,
														"Marker": "Kg=="
													},
													"Properties": {
														"id": "20230307112520-xft3os6",
														"updated": "20230307112521"
													},
													"Children": [
														{
															"ID": "20230307112520-km9pnk5",
															"Type": "NodeParagraph",
															"Properties": {
																"id": "20230307112520-km9pnk5",
																"updated": "20230307112521"
															},
															"Children": [
																{
																	"Type": "NodeText",
																	"Data": "当 order 值较大时，说明内存已碎片化，无法分配连续的大页内存。"
																}
															]
														}
													]
												}
											]
										}
									]
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230307110843-e3wv6un",
			"Type": "NodeHeading",
			"HeadingLevel": 1,
			"Properties": {
				"id": "20230307110843-e3wv6un",
				"updated": "20230307110949"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2. 系统OOM"
				}
			]
		},
		{
			"ID": "20230307111008-hcv7pxr",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230307111008-hcv7pxr",
				"updated": "20230307111201"
			},
			"Children": [
				{
					"ID": "20230307111015-xcrvzx6",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307111015-xcrvzx6"
					},
					"Children": [
						{
							"ID": "20230307111015-18nbjw6",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307111015-18nbjw6"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "原因："
								}
							]
						},
						{
							"ID": "20230307111024-5g8q4lc",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307111024-5g8q4lc"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "内存碎片化严重，系统缺少大页内存，即使是当前系统总内存较多的情况下，也会出现给程序分配内存失败的现象。此时系统会做出内存不够用的误判，认为需要停止一些进程来释放内存，从而导致系统 OOM。"
								}
							]
						}
					]
				},
				{
					"ID": "20230307111028-qtm7eg5",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307111028-qtm7eg5",
						"updated": "20230307111201"
					},
					"Children": [
						{
							"ID": "20230307111028-c2ka1zt",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307111028-c2ka1zt",
								"updated": "20230307111038"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "解决办法"
								}
							]
						},
						{
							"ID": "20230307111039-badrk8r",
							"Type": "NodeList",
							"ListData": {
								"Typ": 1
							},
							"Properties": {
								"id": "20230307111039-badrk8r",
								"updated": "20230307111201"
							},
							"Children": [
								{
									"ID": "20230307111101-fojttcj",
									"Type": "NodeListItem",
									"ListData": {
										"Typ": 1,
										"Delimiter": 46,
										"Marker": "MS4=",
										"Num": 1
									},
									"Properties": {
										"id": "20230307111101-fojttcj"
									},
									"Children": [
										{
											"ID": "20230307111101-5h23fv6",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20230307111101-5h23fv6"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "周期性地或者在发现大块内存不足时，先进行 drop_cache 操作。"
												}
											]
										},
										{
											"ID": "20230307111105-tx18lv3",
											"Type": "NodeCodeBlock",
											"IsFencedCodeBlock": true,
											"Properties": {
												"id": "20230307111105-tx18lv3",
												"updated": "20230307111114"
											},
											"Children": [
												{
													"Type": "NodeCodeBlockFenceOpenMarker",
													"Data": "```"
												},
												{
													"Type": "NodeCodeBlockFenceInfoMarker",
													"CodeBlockInfo": "XA=="
												},
												{
													"Type": "NodeCodeBlockCode",
													"Data": "echo 3 \u003e /proc/sys/vm/drop_caches\n"
												},
												{
													"Type": "NodeCodeBlockFenceCloseMarker",
													"Data": "```"
												}
											]
										}
									]
								},
								{
									"ID": "20230307111126-ynq9pr6",
									"Type": "NodeListItem",
									"ListData": {
										"Typ": 1,
										"Delimiter": 46,
										"Marker": "Mi4=",
										"Num": 2
									},
									"Properties": {
										"id": "20230307111126-ynq9pr6",
										"updated": "20230307111201"
									},
									"Children": [
										{
											"ID": "20230307111126-0gvqquj",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20230307111126-0gvqquj",
												"updated": "20230307111144"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "必要时执行以下操作进行内存整理。"
												},
												{
													"Type": "NodeTextMark",
													"TextMarkType": "mark",
													"TextMarkTextContent": "请谨慎执行此步骤，该操作开销较大，会造成业务卡顿。"
												}
											]
										},
										{
											"ID": "20230307111150-m74sa6n",
											"Type": "NodeCodeBlock",
											"IsFencedCodeBlock": true,
											"Properties": {
												"id": "20230307111150-m74sa6n",
												"updated": "20230307111201"
											},
											"Children": [
												{
													"Type": "NodeCodeBlockFenceOpenMarker",
													"Data": "```"
												},
												{
													"Type": "NodeCodeBlockFenceInfoMarker",
													"CodeBlockInfo": "XA=="
												},
												{
													"Type": "NodeCodeBlockCode",
													"Data": "echo 1 \u003e /proc/sys/vm/compact_memory\n"
												},
												{
													"Type": "NodeCodeBlockFenceCloseMarker",
													"Data": "```"
												}
											]
										}
									]
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230307111140-21zwf8l",
			"Type": "NodeHeading",
			"HeadingLevel": 1,
			"Properties": {
				"id": "20230307111140-21zwf8l",
				"updated": "20230307112534"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "3. 容器启动失败"
				}
			]
		},
		{
			"ID": "20230307112540-uz98y5p",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230307112540-uz98y5p",
				"updated": "20230307112542"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "K8S 会为每个 Pod 创建 netns 来隔离 network namespace，内核初始化 netns 时会为其创建 nf_conntrack 表的 cache，需要申请大页内存，如果此时系统内存已经碎片化，无法分配到足够的大页内存内核就会出现如下报错（"
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "code",
					"TextMarkTextContent": "\u0026lt;span data-slate-string=\u0026quot;true\u0026quot;\u0026gt;v2.6.33 - v4.6\u0026lt;/span\u0026gt;"
				},
				{
					"Type": "NodeText",
					"Data": "）："
				}
			]
		},
		{
			"ID": "20230307112548-9ape744",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230307112548-9ape744",
				"updated": "20230307112628"
			},
			"Children": [
				{
					"ID": "20230307112628-7r4hkx5",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307112628-7r4hkx5"
					},
					"Children": [
						{
							"ID": "20230307112628-p5hcvkl",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307112628-p5hcvkl"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "现象"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230307112601-tps9cev",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230307112601-tps9cev",
				"updated": "20230307112606"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "XA=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "runc:[1:CHILD]: page allocation failure: order:6, mode:0x10c0d0\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230307112634-5oz7azz",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230307112634-5oz7azz",
				"updated": "20230307112634"
			}
		},
		{
			"ID": "20230307112621-vltwqw0",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230307112621-vltwqw0",
				"updated": "20230307112621"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "Pod 将会一直处于 ContainerCreating 状态，dockerd 启动容器也将失败。日志报错如下："
				}
			]
		},
		{
			"ID": "20230307112639-9henghv",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230307112639-9henghv",
				"updated": "20230307112642"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "XA=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "Jan 23 14:15:31 dc05 dockerd: time=\"2019-01-23T14:15:31.288446233+08:00\" level=error msg=\"containerd: start container\" error=\"oci runtime error: container_linux.go:247: starting container process caused \\\"process_linux.go:245: running exec setns process for init caused \\\\\\\"exit status 6\\\\\\\"\\\"\\n\" id=5b9be8c5bb121264899fac8d9d36b02150269d41ce96ba6ad36d70b8640cb01c\nJan 23 14:15:31 dc05 dockerd: time=\"2019-01-23T14:15:31.317965799+08:00\" level=error msg=\"Create container failed with error: invalid header field value \\\"oci runtime error: container_linux.go:247: starting container process caused \\\\\\\"process_linux.go:245: running exec setns process for init caused \\\\\\\\\\\\\\\"exit status 6\\\\\\\\\\\\\\\"\\\\\\\"\\\\n\\\"\"\n\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230307112712-pfymiqb",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230307112712-pfymiqb",
				"updated": "20230307112716"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "kubelet报错"
				}
			]
		},
		{
			"ID": "20230307112704-7bq8gfu",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230307112704-7bq8gfu",
				"updated": "20230307112707"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "XA=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "Jan 23 14:15:31 dc05 kubelet: E0123 14:15:31.352386   26037 remote_runtime.go:91] RunPodSandbox from runtime service failed: rpc error: code = 2 desc = failed to start sandbox container for pod \"matchdataserver-1255064836-t4b2w\": Error response from daemon: {\"message\":\"invalid header field value \\\"oci runtime error: container_linux.go:247: starting container process caused \\\\\\\"process_linux.go:245: running exec setns process for init caused \\\\\\\\\\\\\\\"exit status 6\\\\\\\\\\\\\\\"\\\\\\\"\\\\n\\\"\"}\nJan 23 14:15:31 dc05 kubelet: E0123 14:15:31.352496   26037 kuberuntime_sandbox.go:54] CreatePodSandbox for pod \"matchdataserver-1255064836-t4b2w_basic(485fd485-1ed6-11e9-8661-0a587f8021ea)\" failed: rpc error: code = 2 desc = failed to start sandbox container for pod \"matchdataserver-1255064836-t4b2w\": Error response from daemon: {\"message\":\"invalid header field value \\\"oci runtime error: container_linux.go:247: starting container process caused \\\\\\\"process_linux.go:245: running exec setns process for init caused \\\\\\\\\\\\\\\"exit status 6\\\\\\\\\\\\\\\"\\\\\\\"\\\\n\\\"\"}\nJan 23 14:15:31 dc05 kubelet: E0123 14:15:31.352518   26037 kuberuntime_manager.go:618] createPodSandbox for pod \"matchdataserver-1255064836-t4b2w_basic(485fd485-1ed6-11e9-8661-0a587f8021ea)\" failed: rpc error: code = 2 desc = failed to start sandbox container for pod \"matchdataserver-1255064836-t4b2w\": Error response from daemon: {\"message\":\"invalid header field value \\\"oci runtime error: container_linux.go:247: starting container process caused \\\\\\\"process_linux.go:245: running exec setns process for init caused \\\\\\\\\\\\\\\"exit status 6\\\\\\\\\\\\\\\"\\\\\\\"\\\\n\\\"\"}\nJan 23 14:15:31 dc05 kubelet: E0123 14:15:31.352580   26037 pod_workers.go:182] Error syncing pod 485fd485-1ed6-11e9-8661-0a587f8021ea (\"matchdataserver-1255064836-t4b2w_basic(485fd485-1ed6-11e9-8661-0a587f8021ea)\"), skipping: failed to \"CreatePodSandbox\" for \"matchdataserver-1255064836-t4b2w_basic(485fd485-1ed6-11e9-8661-0a587f8021ea)\" with CreatePodSandboxError: \"CreatePodSandbox for pod \\\"matchdataserver-1255064836-t4b2w_basic(485fd485-1ed6-11e9-8661-0a587f8021ea)\\\" failed: rpc error: code = 2 desc = failed to start sandbox container for pod \\\"matchdataserver-1255064836-t4b2w\\\": Error response from daemon: {\\\"message\\\":\\\"invalid header field value \\\\\\\"oci runtime error: container_linux.go:247: starting container process caused \\\\\\\\\\\\\\\"process_linux.go:245: running exec setns process for init caused \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\"exit status 6\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\"\\\\\\\\\\\\\\\"\\\\\\\\n\\\\\\\"\\\"}\"\nJan 23 14:15:31 dc05 kubelet: I0123 14:15:31.372181   26037 kubelet.go:1916] SyncLoop (PLEG): \"matchdataserver-1255064836-t4b2w_basic(485fd485-1ed6-11e9-8661-0a587f8021ea)\", event: \u0026pleg.PodLifecycleEvent{ID:\"485fd485-1ed6-11e9-8661-0a587f8021ea\", Type:\"ContainerDied\", Data:\"5b9be8c5bb121264899fac8d9d36b02150269d41ce96ba6ad36d70b8640cb01c\"}\nJan 23 14:15:31 dc05 kubelet: W0123 14:15:31.372225   26037 pod_container_deletor.go:77] Container \"5b9be8c5bb121264899fac8d9d36b02150269d41ce96ba6ad36d70b8640cb01c\" not found in pod's containers\nJan 23 14:15:31 dc05 kubelet: I0123 14:15:31.678211   26037 kuberuntime_manager.go:383] No ready sandbox for pod \"matchdataserver-1255064836-t4b2w_basic(485fd485-1ed6-11e9-8661-0a587f8021ea)\" can be found. Need to start a new one\n\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230307112755-zgo8k4a",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230307112755-zgo8k4a",
				"updated": "20230307112804"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "执行命令 "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "code",
					"TextMarkTextContent": "cat /proc/buddyinfo "
				},
				{
					"Type": "NodeText",
					"Data": " 查看 slab，系统不存在大块内存时返回0数量较多。如下所示："
				}
			]
		},
		{
			"ID": "20230307112810-fewdjw0",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230307112810-fewdjw0",
				"updated": "20230307112816"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "XA=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "$ cat /proc/buddyinfo\nNode 0, zone      DMA      1      0      1      0      2      1      1      0      1      1      3\nNode 0, zone    DMA32   2725    624    489    178      0      0      0      0      0      0      0\nNode 0, zone   Normal   1163   1101    932    222      0      0      0      0      0      0      0\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		}
	]
}