{
	"ID": "20230307101834-bn07kz5",
	"Spec": "1",
	"Type": "NodeDocument",
	"Properties": {
		"id": "20230307101834-bn07kz5",
		"title": "集群 Kube-Proxy 异常排障处理",
		"updated": "20230307103839"
	},
	"Children": [
		{
			"ID": "20230307101834-bb49tti",
			"Type": "NodeHeading",
			"HeadingLevel": 1,
			"Properties": {
				"id": "20230307101834-bb49tti",
				"updated": "20230307101918"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "1.  kube-proxy 未能正确适配节点 iptables 后端"
				}
			]
		},
		{
			"ID": "20230307101909-o0j8c2d",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230307101909-o0j8c2d",
				"updated": "20230307101942"
			},
			"Children": [
				{
					"ID": "20230307101929-yzd1uqy",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307101929-yzd1uqy",
						"updated": "20230307101942"
					},
					"Children": [
						{
							"ID": "20230307101929-sbajke1",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307101929-sbajke1",
								"updated": "20230307101933"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "错误信息"
								}
							]
						},
						{
							"ID": "20230307101934-061bmxh",
							"Type": "NodeCodeBlock",
							"IsFencedCodeBlock": true,
							"Properties": {
								"id": "20230307101934-061bmxh",
								"updated": "20230307101942"
							},
							"Children": [
								{
									"Type": "NodeCodeBlockFenceOpenMarker",
									"Data": "```"
								},
								{
									"Type": "NodeCodeBlockFenceInfoMarker",
									"CodeBlockInfo": "XA=="
								},
								{
									"Type": "NodeCodeBlockCode",
									"Data": "Failed to execute iptables-restore: exit status 2 (iptables-restore v1.8.4 (legacy): Couldn't load target 'KUBE-MARK-DROP':No such file or directory\n"
								},
								{
									"Type": "NodeCodeBlockFenceCloseMarker",
									"Data": "```"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230307101942-dc0hmnz",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230307101942-dc0hmnz",
				"updated": "20230307102043"
			},
			"Children": [
				{
					"ID": "20230307101952-m516937",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307101952-m516937",
						"updated": "20230307102043"
					},
					"Children": [
						{
							"ID": "20230307101952-kv3siaw",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307101952-kv3siaw",
								"updated": "20230307101955"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "原因："
								}
							]
						},
						{
							"ID": "20230307102016-twj9er6",
							"Type": "NodeList",
							"ListData": {
								"Typ": 1
							},
							"Properties": {
								"id": "20230307102016-twj9er6",
								"updated": "20230307102036"
							},
							"Children": [
								{
									"ID": "20230307102021-w68l5dn",
									"Type": "NodeListItem",
									"ListData": {
										"Typ": 1,
										"Delimiter": 46,
										"Marker": "MS4=",
										"Num": 1
									},
									"Properties": {
										"id": "20230307102021-w68l5dn",
										"updated": "20230307102036"
									},
									"Children": [
										{
											"ID": "20230307102021-tjzt5bb",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20230307102021-tjzt5bb",
												"updated": "20230307102036"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "一些高版本的 OS 使用的 iptables 后端为 nft，而低版本 kube-proxy 使用的 iptables 后端为 legacy。当低版本 kube-proxy 运行在高版本 OS 上时，会因为 iptables 后端不匹配而读不到  "
												},
												{
													"Type": "NodeTextMark",
													"TextMarkType": "code",
													"TextMarkTextContent": "KUBE-MARK-DRO "
												},
												{
													"Type": "NodeText",
													"Data": "  Chain。"
												}
											]
										}
									]
								}
							]
						},
						{
							"ID": "20230307102005-t7b9llq",
							"Type": "NodeList",
							"ListData": {
								"Typ": 1
							},
							"Properties": {
								"id": "20230307102005-t7b9llq",
								"updated": "20230307102043"
							},
							"Children": [
								{
									"ID": "20230307102025-0uxed3f",
									"Type": "NodeListItem",
									"ListData": {
										"Typ": 1,
										"Delimiter": 46,
										"Marker": "Mi4=",
										"Num": 2
									},
									"Properties": {
										"id": "20230307102025-0uxed3f",
										"updated": "20230307102043"
									},
									"Children": [
										{
											"ID": "20230307102025-8t9i5fc",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20230307102025-8t9i5fc",
												"updated": "20230307102043"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "kube-proxy 在执行 iptables-restore 时，所依赖的 "
												},
												{
													"Type": "NodeTextMark",
													"TextMarkType": "code",
													"TextMarkTextContent": "\u0026lt;span data-slate-string=\u0026quot;true\u0026quot;\u0026gt;KUBE-MARK-DROP\u0026lt;/span\u0026gt;"
												},
												{
													"Type": "NodeText",
													"Data": " Chain 不存在，导致同步规则失败后退出。"
												},
												{
													"Type": "NodeTextMark",
													"TextMarkType": "code",
													"TextMarkTextContent": "KUBE-MARK-DROP "
												},
												{
													"Type": "NodeText",
													"Data": "Chain 由 kubelet 负责维护。"
												}
											]
										}
									]
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230307102141-krinqq3",
			"Type": "NodeHeading",
			"HeadingLevel": 1,
			"Properties": {
				"id": "20230307102141-krinqq3",
				"updated": "20230307102152"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2. kube-proxy 操作 iptables 锁相关的问题"
				}
			]
		},
		{
			"ID": "20230307102221-0p838jc",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20230307102221-0p838jc",
				"updated": "20230307102230"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2.1  其它组件未挂载 iptables 锁导致并发写入失败"
				}
			]
		},
		{
			"ID": "20230307102233-l4t68dv",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230307102233-l4t68dv",
				"updated": "20230307102249"
			},
			"Children": [
				{
					"ID": "20230307102234-uljscbg",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307102234-uljscbg",
						"updated": "20230307102249"
					},
					"Children": [
						{
							"ID": "20230307102234-74lg9cv",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307102234-74lg9cv",
								"updated": "20230307102238"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "错误信息"
								}
							]
						},
						{
							"ID": "20230307102240-btri0tm",
							"Type": "NodeCodeBlock",
							"IsFencedCodeBlock": true,
							"Properties": {
								"id": "20230307102240-btri0tm",
								"updated": "20230307102249"
							},
							"Children": [
								{
									"Type": "NodeCodeBlockFenceOpenMarker",
									"Data": "```"
								},
								{
									"Type": "NodeCodeBlockFenceInfoMarker",
									"CodeBlockInfo": "XA=="
								},
								{
									"Type": "NodeCodeBlockCode",
									"Data": "Failed to execute iptables-restore: exit status 1 (iptables-restore: line xxx failed)\n"
								},
								{
									"Type": "NodeCodeBlockFenceCloseMarker",
									"Data": "```"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230307102306-xo95yhl",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230307102306-xo95yhl",
				"updated": "20230307102358"
			},
			"Children": [
				{
					"ID": "20230307102307-plh7468",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307102307-plh7468",
						"updated": "20230307102358"
					},
					"Children": [
						{
							"ID": "20230307102307-pz4dry8",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307102307-pz4dry8",
								"updated": "20230307102312"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "原因"
								}
							]
						},
						{
							"ID": "20230307102313-0jfnqed",
							"Type": "NodeList",
							"ListData": {
								"Typ": 1
							},
							"Properties": {
								"id": "20230307102313-0jfnqed",
								"updated": "20230307102358"
							},
							"Children": [
								{
									"ID": "20230307102317-wiemiqm",
									"Type": "NodeListItem",
									"ListData": {
										"Typ": 1,
										"Delimiter": 46,
										"Marker": "MS4=",
										"Num": 1
									},
									"Properties": {
										"id": "20230307102317-wiemiqm"
									},
									"Children": [
										{
											"ID": "20230307102317-ucbbyo3",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20230307102317-ucbbyo3",
												"updated": "20230307102338"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "iptables 相关命令（如 iptables-restore）在向内核写入 iptables 规则时，为了避免多个实例并发写入，会利用 file lock 来做同步，linux 下该文件一般为："
												},
												{
													"Type": "NodeTextMark",
													"TextMarkType": "code",
													"TextMarkTextContent": "/run/xtables.lock "
												}
											]
										}
									]
								},
								{
									"ID": "20230307102350-2cc2w98",
									"Type": "NodeListItem",
									"ListData": {
										"Typ": 1,
										"Delimiter": 46,
										"Marker": "Mi4=",
										"Num": 2
									},
									"Properties": {
										"id": "20230307102350-2cc2w98",
										"updated": "20230307102358"
									},
									"Children": [
										{
											"ID": "20230307102350-7lzzt6w",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20230307102350-7lzzt6w",
												"updated": "20230307102358"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "对于要调用 iptables 相关命令的 Pod，如 kube-proxy, kube-router 以及客户侧的 HostNetwork Pod，如果没有挂载该文件，可能发生如上并发写入的错误"
												}
											]
										}
									]
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230307102325-jqawonc",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230307102325-jqawonc",
				"updated": "20230307102447"
			},
			"Children": [
				{
					"ID": "20230307102408-yvo00kt",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307102408-yvo00kt",
						"updated": "20230307102447"
					},
					"Children": [
						{
							"ID": "20230307102408-9brsrfn",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307102408-9brsrfn",
								"updated": "20230307102412"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "解决办法"
								}
							]
						},
						{
							"ID": "20230307102413-3qpdqee",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307102413-3qpdqee",
								"updated": "20230307102447"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "调用 iptables 相关命令的 Pod 需要将主机侧 "
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "code",
									"TextMarkTextContent": "/run/xtables.lock "
								},
								{
									"Type": "NodeText",
									"Data": " 文件挂载到 Pod 中，配置方式如下："
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230307102424-2spwkd7",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230307102424-2spwkd7",
				"updated": "20230307102436"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "XA=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "        volumeMounts:\n        -   mountPath: /run/xtables.lock\n          name: xtables-lock\n          readOnly: false\n      volumes:\n      -   hOStPath:\n          path: /run/xtables.lock\n          type: FileOrCreate\n        name: xtables-lock\n\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230307102449-vt8pc04",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20230307102449-vt8pc04",
				"updated": "20230307102507"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2.2 iptables-restore 版本低导致不支持阻塞写入"
				}
			]
		},
		{
			"ID": "20230307102511-lsh7o5i",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230307102511-lsh7o5i",
				"updated": "20230307102526"
			},
			"Children": [
				{
					"ID": "20230307102513-8ip4e0x",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307102513-8ip4e0x",
						"updated": "20230307102526"
					},
					"Children": [
						{
							"ID": "20230307102513-jel1x22",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307102513-jel1x22",
								"updated": "20230307102518"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "错误信息"
								}
							]
						},
						{
							"ID": "20230307102518-7k6es6m",
							"Type": "NodeCodeBlock",
							"IsFencedCodeBlock": true,
							"Properties": {
								"id": "20230307102518-7k6es6m",
								"updated": "20230307102526"
							},
							"Children": [
								{
									"Type": "NodeCodeBlockFenceOpenMarker",
									"Data": "```"
								},
								{
									"Type": "NodeCodeBlockFenceInfoMarker",
									"CodeBlockInfo": "XA=="
								},
								{
									"Type": "NodeCodeBlockCode",
									"Data": "Failed to execute iptables-restore: exit status 4 (Another app is currently holding the xtables lock. Perhaps you want to use the -w option?)\n"
								},
								{
									"Type": "NodeCodeBlockFenceCloseMarker",
									"Data": "```"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230307102531-2aiz135",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230307102531-2aiz135",
				"updated": "20230307102647"
			},
			"Children": [
				{
					"ID": "20230307102532-wzq8f44",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307102532-wzq8f44",
						"updated": "20230307102647"
					},
					"Children": [
						{
							"ID": "20230307102532-1wnr7w3",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307102532-1wnr7w3",
								"updated": "20230307102536"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "原因"
								}
							]
						},
						{
							"ID": "20230307102536-9s8tkze",
							"Type": "NodeList",
							"ListData": {
								"Typ": 1
							},
							"Properties": {
								"id": "20230307102536-9s8tkze",
								"updated": "20230307102647"
							},
							"Children": [
								{
									"ID": "20230307102546-x9bl5nw",
									"Type": "NodeListItem",
									"ListData": {
										"Typ": 1,
										"Delimiter": 46,
										"Marker": "MS4=",
										"Num": 1
									},
									"Properties": {
										"id": "20230307102546-x9bl5nw"
									},
									"Children": [
										{
											"ID": "20230307102546-rxchqhc",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20230307102546-rxchqhc",
												"updated": "20230307102546"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "iptables 相关命令（如 iptables-restore）在向内核写入 iptables 规则时，为了避免多个实例并发写入，会利用 file lock 来做同步，iptables-restore 在执行时首先尝试获取 file lock，如果当前有其它进程持有锁，则退出。"
												}
											]
										}
									]
								},
								{
									"ID": "20230307102558-kw7e0il",
									"Type": "NodeListItem",
									"ListData": {
										"Typ": 1,
										"Delimiter": 46,
										"Marker": "Mi4=",
										"Num": 2
									},
									"Properties": {
										"id": "20230307102558-kw7e0il"
									},
									"Children": [
										{
											"ID": "20230307102558-rkzv9jo",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20230307102558-rkzv9jo",
												"updated": "20230307102559"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "该报错是一个软错误，kube-proxy 会在下个同步周期（或下个 Service 相关的事件触发时）再次尝试执行，如果重试多次都获取不到锁，则表现为规则同步时延较大。"
												}
											]
										}
									]
								},
								{
									"ID": "20230307102625-lizycfl",
									"Type": "NodeListItem",
									"ListData": {
										"Typ": 1,
										"Delimiter": 46,
										"Marker": "My4=",
										"Num": 3
									},
									"Properties": {
										"id": "20230307102625-lizycfl",
										"updated": "20230307102647"
									},
									"Children": [
										{
											"ID": "20230307102625-8ruxdtu",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20230307102625-8ruxdtu",
												"updated": "20230307102647"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "高版本 iptables-restore 提供了一个 "
												},
												{
													"Type": "NodeTextMark",
													"TextMarkType": "code",
													"TextMarkTextContent": "-w(--wait"
												},
												{
													"Type": "NodeText",
													"Data": ") 选项，如设置 -w=5 时，iptables-restore 会在拿锁操作阻塞 5s，这使得 5s 内一旦其它进程释放锁，iptables-restore 可以继续操作。"
												}
											]
										}
									]
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230307102716-2r5bugy",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20230307102716-2r5bugy",
				"updated": "20230307102725"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2.3 其它组件持有 iptables 锁时间过长"
				}
			]
		},
		{
			"ID": "20230307102728-nc4lvbo",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230307102728-nc4lvbo",
				"updated": "20230307102743"
			},
			"Children": [
				{
					"ID": "20230307102729-gdydsrp",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307102729-gdydsrp",
						"updated": "20230307102743"
					},
					"Children": [
						{
							"ID": "20230307102729-aem0ohk",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307102729-aem0ohk",
								"updated": "20230307102732"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "错误信息"
								}
							]
						},
						{
							"ID": "20230307102734-wac48fv",
							"Type": "NodeCodeBlock",
							"IsFencedCodeBlock": true,
							"Properties": {
								"id": "20230307102734-wac48fv",
								"updated": "20230307102743"
							},
							"Children": [
								{
									"Type": "NodeCodeBlockFenceOpenMarker",
									"Data": "```"
								},
								{
									"Type": "NodeCodeBlockFenceInfoMarker",
									"CodeBlockInfo": "XA=="
								},
								{
									"Type": "NodeCodeBlockCode",
									"Data": "Failed to ensure that filter chain KUBE-SERVICES exists: error creating chain \"KUBE-EXTERNAL-SERVICES\": exit status 4: Another app is currently holding the xtables lock. Stopped waiting after 5s.\n"
								},
								{
									"Type": "NodeCodeBlockFenceCloseMarker",
									"Data": "```"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230307102757-5mnrgoa",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230307102757-5mnrgoa",
				"updated": "20230307102927"
			},
			"Children": [
				{
					"ID": "20230307102758-xk3kg7r",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307102758-xk3kg7r"
					},
					"Children": [
						{
							"ID": "20230307102758-eqbx5qj",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307102758-eqbx5qj",
								"updated": "20230307102803"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "原因"
								}
							]
						},
						{
							"ID": "20230307102804-no05qzp",
							"Type": "NodeList",
							"ListData": {
								"Typ": 1
							},
							"Properties": {
								"id": "20230307102804-no05qzp",
								"updated": "20230307102806"
							},
							"Children": [
								{
									"ID": "20230307102806-lzkgvte",
									"Type": "NodeListItem",
									"ListData": {
										"Typ": 1,
										"Delimiter": 46,
										"Marker": "MS4=",
										"Num": 1
									},
									"Properties": {
										"id": "20230307102806-lzkgvte"
									},
									"Children": [
										{
											"ID": "20230307102806-6ao78ks",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20230307102806-6ao78ks",
												"updated": "20230307102822"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "iptables 相关命令（如 iptables-restore）在向内核写入 iptables 规则时，为了避免多个实例并发写入，会利用 file lock 来做同步，iptables-restore 在执行时首先尝试获取 file lock，如果当前有其它进程持有锁，则阻塞特定时间（取决于-w 参数的值，默认5s），该时间内拿到锁，则继续操作，拿不到则退出。"
												}
											]
										}
									]
								},
								{
									"ID": "20230307102830-i88l82g",
									"Type": "NodeListItem",
									"ListData": {
										"Typ": 1,
										"Delimiter": 46,
										"Marker": "Mi4=",
										"Num": 2
									},
									"Properties": {
										"id": "20230307102830-i88l82g"
									},
									"Children": [
										{
											"ID": "20230307102830-fd9oa0z",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20230307102830-fd9oa0z",
												"updated": "20230307102831"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "该报错说明其它组件持有 iptables file lock 时间超过 5s"
												}
											]
										}
									]
								}
							]
						}
					]
				},
				{
					"ID": "20230307102850-u48u0kj",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307102850-u48u0kj",
						"updated": "20230307102927"
					},
					"Children": [
						{
							"ID": "20230307102850-n8ou2fz",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307102850-n8ou2fz",
								"updated": "20230307102901"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "解决办法"
								}
							]
						},
						{
							"ID": "20230307102901-1lyq2zt",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307102901-1lyq2zt",
								"updated": "20230307102927"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "尽量减小其它组件持有 iptables file lock 的时间，如 TKE 控制台组件管理提供的 NetworkPolicy（kube-router）组件，其低版本持有 iptables 锁的时间较长，可以通过升级来解决，当前最新版为："
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "code",
									"TextMarkTextContent": "v1.3.2 "
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230307102930-h4lswsx",
			"Type": "NodeHeading",
			"HeadingLevel": 1,
			"Properties": {
				"id": "20230307102930-h4lswsx",
				"updated": "20230307103137"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "3. kube-proxy 到 kube-apiserver 连接异常"
				}
			]
		},
		{
			"ID": "20230307103007-dw1mqa5",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230307103007-dw1mqa5",
				"updated": "20230307103034"
			},
			"Children": [
				{
					"ID": "20230307103021-iwd8y07",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307103021-iwd8y07",
						"updated": "20230307103034"
					},
					"Children": [
						{
							"ID": "20230307103021-whe6s9u",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307103021-whe6s9u"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "错误信息"
								}
							]
						},
						{
							"ID": "20230307103026-zq3u3tr",
							"Type": "NodeCodeBlock",
							"IsFencedCodeBlock": true,
							"Properties": {
								"id": "20230307103026-zq3u3tr",
								"updated": "20230307103034"
							},
							"Children": [
								{
									"Type": "NodeCodeBlockFenceOpenMarker",
									"Data": "```"
								},
								{
									"Type": "NodeCodeBlockFenceInfoMarker",
									"CodeBlockInfo": "XA=="
								},
								{
									"Type": "NodeCodeBlockCode",
									"Data": "Failed to list *core.Endpoints: Stream error http2.StreamError{StreamID:0xea1, Code:0x2, Cause:error(nil)} when reading response body, may be caused by closed connection. Please retry.\n"
								},
								{
									"Type": "NodeCodeBlockFenceCloseMarker",
									"Data": "```"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230307103023-px1weve",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230307103023-px1weve",
				"updated": "20230307103057"
			},
			"Children": [
				{
					"ID": "20230307103042-mf6qizh",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307103042-mf6qizh",
						"updated": "20230307103057"
					},
					"Children": [
						{
							"ID": "20230307103042-i5w2fbw",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307103042-i5w2fbw",
								"updated": "20230307103045"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "原因"
								}
							]
						},
						{
							"ID": "20230307103046-qc5aguy",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307103046-qc5aguy",
								"updated": "20230307103057"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "低版本 Kubernetes 调用 go http2 的包存在一个 bug，该 bug 导致客户端会使用到一个 apiserver 的已经关闭的连接，kube-proxy 踩中这个 bug 后，会导致同步规则失败。更多详情可参考 "
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://github.com/kubernetes/kubernetes/issues/87615",
									"TextMarkATitle": "https://github.com/kubernetes/kubernetes/issues/87615",
									"TextMarkTextContent": "Issue87615"
								},
								{
									"Type": "NodeText",
									"Data": "、"
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://github.com/kubernetes/kubernetes/pull/95981",
									"TextMarkATitle": "https://github.com/kubernetes/kubernetes/pull/95981",
									"TextMarkTextContent": "PR95981"
								},
								{
									"Type": "NodeText",
									"Data": "。"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230307103130-enixlb4",
			"Type": "NodeHeading",
			"HeadingLevel": 1,
			"Properties": {
				"id": "20230307103130-enixlb4",
				"updated": "20230307103140"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "4. kube-proxy 首次启动发生 panic，重启后正常"
				}
			]
		},
		{
			"ID": "20230307103143-3atmj16",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230307103143-3atmj16",
				"updated": "20230307103206"
			},
			"Children": [
				{
					"ID": "20230307103151-5ypie98",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307103151-5ypie98",
						"updated": "20230307103206"
					},
					"Children": [
						{
							"ID": "20230307103151-fruac8y",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307103151-fruac8y",
								"updated": "20230307103153"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "错误信息"
								}
							]
						},
						{
							"ID": "20230307103153-1znj3yo",
							"Type": "NodeCodeBlock",
							"IsFencedCodeBlock": true,
							"Properties": {
								"id": "20230307103153-1znj3yo",
								"updated": "20230307103206"
							},
							"Children": [
								{
									"Type": "NodeCodeBlockFenceOpenMarker",
									"Data": "```"
								},
								{
									"Type": "NodeCodeBlockFenceInfoMarker",
									"CodeBlockInfo": "XA=="
								},
								{
									"Type": "NodeCodeBlockCode",
									"Data": "panic: runtime error: invalid memory address or nil pointer dereference\n[signal SIGSEGV: segmentation violation code=0x1 addr=0x50 pc=0x1514fb8]\n"
								},
								{
									"Type": "NodeCodeBlockFenceCloseMarker",
									"Data": "```"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230307103210-cgvfq7a",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230307103210-cgvfq7a",
				"updated": "20230307103212"
			},
			"Children": [
				{
					"ID": "20230307103212-3ynmidv",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307103212-3ynmidv"
					},
					"Children": [
						{
							"ID": "20230307103212-bny4gst",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307103212-bny4gst",
								"updated": "20230307103216"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "原因"
								}
							]
						},
						{
							"ID": "20230307103216-mahbi0e",
							"Type": "NodeList",
							"ListData": {
								"Typ": 1
							},
							"Properties": {
								"id": "20230307103216-mahbi0e",
								"updated": "20230307103219"
							},
							"Children": [
								{
									"ID": "20230307103219-46op127",
									"Type": "NodeListItem",
									"ListData": {
										"Typ": 1,
										"Delimiter": 46,
										"Marker": "MS4=",
										"Num": 1
									},
									"Properties": {
										"id": "20230307103219-46op127"
									},
									"Children": [
										{
											"ID": "20230307103219-ke0nnw5",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20230307103219-ke0nnw5",
												"updated": "20230307103231"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "该版本 kube-proxy 社区的代码存在 bug，初始化时统计加载的内核模块有缺失，导致有变量未初始化即使用。"
												}
											]
										}
									]
								},
								{
									"ID": "20230307103232-axbfqrg",
									"Type": "NodeListItem",
									"ListData": {
										"Typ": 1,
										"Delimiter": 46,
										"Marker": "Mi4=",
										"Num": 2
									},
									"Properties": {
										"id": "20230307103232-axbfqrg"
									},
									"Children": [
										{
											"ID": "20230307103232-dbuvhtd",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20230307103232-dbuvhtd",
												"updated": "20230307103243"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "日志不够详尽，未输出是否能使用 ipvs 模式的判断结果。更多详情可参考 "
												},
												{
													"Type": "NodeTextMark",
													"TextMarkType": "a",
													"TextMarkAHref": "https://github.com/kubernetes/kubernetes/issues/89729",
													"TextMarkATitle": "https://github.com/kubernetes/kubernetes/issues/89729",
													"TextMarkTextContent": "Issue89729"
												},
												{
													"Type": "NodeText",
													"Data": "、"
												},
												{
													"Type": "NodeTextMark",
													"TextMarkType": "a",
													"TextMarkAHref": "https://github.com/kubernetes/kubernetes/pull/89823",
													"TextMarkATitle": "https://github.com/kubernetes/kubernetes/pull/89823",
													"TextMarkTextContent": "PR89823"
												},
												{
													"Type": "NodeText",
													"Data": "、"
												},
												{
													"Type": "NodeTextMark",
													"TextMarkType": "a",
													"TextMarkAHref": "https://github.com/kubernetes/kubernetes/pull/89785",
													"TextMarkATitle": "https://github.com/kubernetes/kubernetes/pull/89785",
													"TextMarkTextContent": "PR89785"
												},
												{
													"Type": "NodeText",
													"Data": "。"
												}
											]
										}
									]
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230307103251-a9z7hna",
			"Type": "NodeHeading",
			"HeadingLevel": 1,
			"Properties": {
				"id": "20230307103251-a9z7hna",
				"updated": "20230307103300"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "5. kube-proxy 不间断 panic"
				}
			]
		},
		{
			"ID": "20230307103305-49b4rr0",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230307103305-49b4rr0",
				"updated": "20230307103308"
			},
			"Children": [
				{
					"ID": "20230307103308-e5p8cai",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307103308-e5p8cai"
					},
					"Children": [
						{
							"ID": "20230307103308-c7lstpy",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307103308-c7lstpy",
								"updated": "20230307103312"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "错误信息"
								}
							]
						},
						{
							"ID": "20230307103335-yzqaao1",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307103335-yzqaao1",
								"updated": "20230307103341"
							},
							"Children": [
								{
									"Type": "NodeTextMark",
									"TextMarkType": "code",
									"TextMarkTextContent": "Observed a panic: \u0026quot;slice bounds out of range\u0026quot;(runtime error: slice bounds out of range)"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230307103313-ecvb6ye",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230307103313-ecvb6ye",
				"updated": "20230307103535"
			},
			"Children": [
				{
					"ID": "20230307103526-a0ssv8r",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307103526-a0ssv8r",
						"updated": "20230307103535"
					},
					"Children": [
						{
							"ID": "20230307103526-ddeb27w",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307103526-ddeb27w"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "原因"
								}
							]
						},
						{
							"ID": "20230307103532-0fkarwv",
							"Type": "NodeList",
							"ListData": {
								"Typ": 1
							},
							"Properties": {
								"id": "20230307103532-0fkarwv",
								"updated": "20230307103535"
							},
							"Children": [
								{
									"ID": "20230307103535-l4uuzuq",
									"Type": "NodeListItem",
									"ListData": {
										"Typ": 1,
										"Delimiter": 46,
										"Marker": "MS4=",
										"Num": 1
									},
									"Properties": {
										"id": "20230307103535-l4uuzuq",
										"updated": "20230307103535"
									},
									"Children": [
										{
											"ID": "20230307103535-3vqzwk9",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20230307103535-3vqzwk9",
												"updated": "20230307103535"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "kube-proxy 社区的代码存在 bug，在执行 iptables-save 时将标准输出和标准错误定向到同一个 buffer 中，而这两者的输出先后顺序是不确定的，这导致 buffer 中的数据格式不符合预期，在处理时发生 panic。更多详情可参考 "
												},
												{
													"Type": "NodeTextMark",
													"TextMarkType": "a",
													"TextMarkAHref": "https://github.com/kubernetes/kubernetes/issues/78443",
													"TextMarkATitle": "https://github.com/kubernetes/kubernetes/issues/78443",
													"TextMarkTextContent": "Issue78443"
												},
												{
													"Type": "NodeText",
													"Data": "、"
												},
												{
													"Type": "NodeTextMark",
													"TextMarkType": "a",
													"TextMarkAHref": "https://github.com/kubernetes/kubernetes/pull/78428",
													"TextMarkATitle": "https://github.com/kubernetes/kubernetes/pull/78428",
													"TextMarkTextContent": "PR78428"
												},
												{
													"Type": "NodeText",
													"Data": "。"
												}
											]
										}
									]
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230307103354-scllahk",
			"Type": "NodeHeading",
			"HeadingLevel": 1,
			"Properties": {
				"id": "20230307103354-scllahk",
				"updated": "20230307103434"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "6. kube-proxy ipvs 模式下周期性占用较高 CPU"
				}
			]
		},
		{
			"ID": "20230307103517-hpwrfy4",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230307103517-hpwrfy4",
				"updated": "20230307103759"
			},
			"Children": [
				{
					"ID": "20230307103548-03d0av6",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307103548-03d0av6"
					},
					"Children": [
						{
							"ID": "20230307103548-hh8u9nf",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307103548-hh8u9nf",
								"updated": "20230307103553"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "原因"
								}
							]
						},
						{
							"ID": "20230307103554-99x3v5b",
							"Type": "NodeList",
							"ListData": {
								"Typ": 1
							},
							"Properties": {
								"id": "20230307103554-99x3v5b",
								"updated": "20230307103556"
							},
							"Children": [
								{
									"ID": "20230307103556-ynihw48",
									"Type": "NodeListItem",
									"ListData": {
										"Typ": 1,
										"Delimiter": 46,
										"Marker": "MS4=",
										"Num": 1
									},
									"Properties": {
										"id": "20230307103556-ynihw48"
									},
									"Children": [
										{
											"ID": "20230307103556-0uaokye",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20230307103556-0uaokye"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "kube-proxy 频繁刷新节点 Service 转发规则导致，触发原因："
												}
											]
										},
										{
											"ID": "20230307103556-hwe8365",
											"Type": "NodeList",
											"ListData": {},
											"Properties": {
												"id": "20230307103556-hwe8365",
												"updated": "20230307103603"
											},
											"Children": [
												{
													"ID": "20230307103603-3ns1bxi",
													"Type": "NodeListItem",
													"ListData": {
														"BulletChar": 42,
														"Marker": "Kg=="
													},
													"Properties": {
														"id": "20230307103603-3ns1bxi"
													},
													"Children": [
														{
															"ID": "20230307103603-25kcj63",
															"Type": "NodeParagraph",
															"Properties": {
																"id": "20230307103603-25kcj63"
															},
															"Children": [
																{
																	"Type": "NodeText",
																	"Data": "kube-proxy 周期性同步规则较为频繁。"
																}
															]
														}
													]
												}
											]
										},
										{
											"ID": "20230307103556-lfgf2d4",
											"Type": "NodeList",
											"ListData": {},
											"Properties": {
												"id": "20230307103556-lfgf2d4",
												"updated": "20230307103606"
											},
											"Children": [
												{
													"ID": "20230307103606-fltpx27",
													"Type": "NodeListItem",
													"ListData": {
														"BulletChar": 42,
														"Marker": "Kg=="
													},
													"Properties": {
														"id": "20230307103606-fltpx27"
													},
													"Children": [
														{
															"ID": "20230307103606-9v9yr2u",
															"Type": "NodeParagraph",
															"Properties": {
																"id": "20230307103606-9v9yr2u"
															},
															"Children": [
																{
																	"Type": "NodeText",
																	"Data": "业务 Service 或 Pod 变更频繁。"
																}
															]
														}
													]
												}
											]
										}
									]
								}
							]
						}
					]
				},
				{
					"ID": "20230307103610-xbb66sk",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230307103610-xbb66sk",
						"updated": "20230307103759"
					},
					"Children": [
						{
							"ID": "20230307103610-fd0nnbi",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230307103610-fd0nnbi",
								"updated": "20230307103618"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "解决办法"
								}
							]
						},
						{
							"ID": "20230307103621-7jckjn8",
							"Type": "NodeList",
							"ListData": {
								"Typ": 1
							},
							"Properties": {
								"id": "20230307103621-7jckjn8",
								"updated": "20230307103759"
							},
							"Children": [
								{
									"ID": "20230307103631-vvsgr55",
									"Type": "NodeListItem",
									"ListData": {
										"Typ": 1,
										"Delimiter": 46,
										"Marker": "MS4=",
										"Num": 1
									},
									"Properties": {
										"id": "20230307103631-vvsgr55",
										"updated": "20230307103759"
									},
									"Children": [
										{
											"ID": "20230307103631-pamlqjv",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20230307103631-pamlqjv",
												"updated": "20230307103632"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "kube-proxy 周期性同步规则较为频繁导致，需要调整其相关参数，旧版本 kube-proxy 的参数默认为："
												}
											]
										},
										{
											"ID": "20230307103645-po2qk4z",
											"Type": "NodeCodeBlock",
											"IsFencedCodeBlock": true,
											"Properties": {
												"id": "20230307103645-po2qk4z",
												"updated": "20230307103649"
											},
											"Children": [
												{
													"Type": "NodeCodeBlockFenceOpenMarker",
													"Data": "```"
												},
												{
													"Type": "NodeCodeBlockFenceInfoMarker",
													"CodeBlockInfo": "XA=="
												},
												{
													"Type": "NodeCodeBlockCode",
													"Data": "--ipvs-min-sync-period=1s（最小刷新间隔1s）\n--ipvs-sync-period=5s（5s周期性刷新）\n"
												},
												{
													"Type": "NodeCodeBlockFenceCloseMarker",
													"Data": "```"
												}
											]
										},
										{
											"ID": "20230307103758-k6egfxj",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20230307103758-k6egfxj",
												"updated": "20230307103759"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "导致 kube-proxy 每5s刷新一次节点 iptables 规则，消耗较多 CPU，推荐改为："
												}
											]
										},
										{
											"ID": "20230307103733-b6xgw5h",
											"Type": "NodeCodeBlock",
											"IsFencedCodeBlock": true,
											"Properties": {
												"id": "20230307103733-b6xgw5h",
												"updated": "20230307103742"
											},
											"Children": [
												{
													"Type": "NodeCodeBlockFenceOpenMarker",
													"Data": "```"
												},
												{
													"Type": "NodeCodeBlockFenceInfoMarker",
													"CodeBlockInfo": "XA=="
												},
												{
													"Type": "NodeCodeBlockCode",
													"Data": "--ipvs-min-sync-period=0s（发生事件实时刷新）\n--ipvs-sync-period=30s（30s周期性刷新） \n\n"
												},
												{
													"Type": "NodeCodeBlockFenceCloseMarker",
													"Data": "```"
												}
											]
										}
									]
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230307103703-pliyr2c",
			"Type": "NodeHeading",
			"HeadingLevel": 1,
			"Properties": {
				"id": "20230307103703-pliyr2c",
				"updated": "20230307103835"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "参考链接："
				}
			]
		},
		{
			"ID": "20230307103839-yo724ql",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230307103839-yo724ql",
				"updated": "20230307103839"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "https://cloud.tencent.com/document/product/457/79797#kube-proxy-.E4.B8.8D.E9.97.B4.E6.96.AD-panic"
				}
			]
		},
		{
			"ID": "20230307103800-4pikgew",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230307103800-4pikgew",
				"updated": "20230307103800"
			}
		}
	]
}