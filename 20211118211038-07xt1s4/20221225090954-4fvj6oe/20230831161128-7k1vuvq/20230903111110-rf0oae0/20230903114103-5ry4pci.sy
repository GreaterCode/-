{
	"ID": "20230903114103-5ry4pci",
	"Spec": "1",
	"Type": "NodeDocument",
	"Properties": {
		"id": "20230903114103-5ry4pci",
		"scroll": "{\u0026quot;startId\u0026quot;:\u0026quot;20230903114338-vpg9kn2\u0026quot;,\u0026quot;endId\u0026quot;:\u0026quot;20230903114859-yw13puq\u0026quot;,\u0026quot;scrollTop\u0026quot;:536,\u0026quot;focusId\u0026quot;:\u0026quot;20230903114627-b2u80ml\u0026quot;,\u0026quot;focusStart\u0026quot;:0,\u0026quot;focusEnd\u0026quot;:0}",
		"title": "1.6  使用NodePort场景",
		"updated": "20230903114859"
	},
	"Children": [
		{
			"ID": "20230903114338-vpg9kn2",
			"Type": "NodeHeading",
			"HeadingLevel": 1,
			"Properties": {
				"id": "20230903114338-vpg9kn2",
				"updated": "20230903114354"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "1.传统NodePort场景"
				}
			]
		},
		{
			"ID": "20230903114123-n448oih",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230903114123-n448oih",
				"updated": "20230903114128"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "K8S 服务对外暴露传统方案是 LB 绑定 Service 的 NodePort 流量从 LB 打到 NodePort 之后再由 kube-proxy 生成的 ipvs 或 iptables 规则进行转发:"
				}
			]
		},
		{
			"ID": "20230903114153-7te6xdx",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230903114153-7te6xdx",
				"updated": "20230903114153"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "​"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "image"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "assets/image-20230903114153-yyjf6an.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20230903114109-dft2ebf",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230903114109-dft2ebf",
				"updated": "20230903114202"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "这样当滚动更新时，LB 绑定的 NodePort 一般无需变动，也就不需要担心 LB 解绑导致对业务有损。"
				}
			]
		},
		{
			"ID": "20230903114425-cypntog",
			"Type": "NodeHeading",
			"HeadingLevel": 1,
			"Properties": {
				"id": "20230903114425-cypntog",
				"updated": "20230903114436"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2. LB直通Pod场景"
				}
			]
		},
		{
			"ID": "20230903114447-4i7ivhy",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230903114447-4i7ivhy",
				"updated": "20230903114447"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "现在很多云厂商也都支持了 LB 直通 Pod，即 LB 直接将流量转发给 Pod，不需要再经过集群内做一次转发:"
				}
			]
		},
		{
			"ID": "20230903114103-ex33rpl",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230903114103-ex33rpl",
				"updated": "20230903114103"
			}
		},
		{
			"ID": "20230903114411-vqrqkyc",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230903114411-vqrqkyc",
				"updated": "20230903114413"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "​"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "image"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "assets/image-20230903114413-h90iv0b.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20230903114458-fi1fhmw",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230903114458-fi1fhmw",
				"updated": "20230903114459"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "当滚动更新时，LB 就需要解绑旧 Pod，绑定新 Pod，如果 LB 到旧 Pod 上的存量连接的存量请求还没处理完，直接解绑的话就可能造成请求异常；我们期望的是，等待存量请求处理完，LB 才真正解绑旧 Pod。"
				}
			]
		},
		{
			"ID": "20230903114540-mn6ybo0",
			"Type": "NodeHeading",
			"HeadingLevel": 1,
			"Properties": {
				"id": "20230903114540-mn6ybo0",
				"updated": "20230903114552"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "3. 解决方案"
				}
			]
		},
		{
			"ID": "20230903114627-b2u80ml",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20230903114627-b2u80ml",
				"updated": "20230903114632"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "3.1 TKE"
				}
			]
		},
		{
			"ID": "20230903114639-8ko98rz",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230903114639-8ko98rz",
				"updated": "20230903114639"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "腾讯云 TKE 官方针对四层 Service 和七层 Ingress 都提供了解决方案。"
				}
			]
		},
		{
			"ID": "20230903114639-ne2u5cn",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230903114639-ne2u5cn",
				"updated": "20230903114639"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "如果是四层 Service，在 Service 上加上这样的注解即可(前提是 Service 用了 CLB 直通 Pod 模式):"
				}
			]
		},
		{
			"ID": "20230903114650-eualp8i",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230903114650-eualp8i",
				"updated": "20230903114650"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "eWFtbA=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "service.cloud.tencent.com/enable-grace-shutdown: \"true\"\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230903114650-67rto8g",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20230903114650-67rto8g",
				"updated": "20230903114705"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20230903114650-m0uklps",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20230903114650-m0uklps",
						"updated": "20230903114705"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "参考官方文档 "
						},
						{
							"Type": "NodeTextMark",
							"TextMarkType": "a",
							"TextMarkAHref": "https://cloud.tencent.com/document/product/457/60064",
							"TextMarkTextContent": "Service 优雅停机"
						}
					]
				}
			]
		},
		{
			"ID": "20230903114725-ntvl2lu",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230903114725-ntvl2lu",
				"updated": "20230903114725"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "如果是七层 CLB 类型 Ingress，在 Ingress 上加上这样的注解即可(前提是 Service 用了 CLB 直通 Pod 模式):"
				}
			]
		},
		{
			"ID": "20230903114802-h1dsdop",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230903114802-h1dsdop",
				"updated": "20230903114802"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "eWFtbA=="
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "ingress.cloud.tencent.com/enable-grace-shutdown: \"true\"\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230903114753-pecv5ql",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230903114753-pecv5ql",
				"updated": "20230903114753"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "参考官方文档 "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://cloud.tencent.com/document/product/457/60065",
					"TextMarkTextContent": "Ingress 优雅停机"
				}
			]
		},
		{
			"ID": "20230903114817-5fwkzul",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20230903114817-5fwkzul",
				"updated": "20230903114828"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "3.2 ACK"
				}
			]
		},
		{
			"ID": "20230903114833-o40nexo",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230903114833-o40nexo",
				"updated": "20230903114833"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "阿里云 ACK 目前只针对四层 Service 提供了解决方案，通过注解开启优雅中断与设置中断超时时间:"
				}
			]
		},
		{
			"ID": "20230903114848-rd5q99e",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230903114848-rd5q99e",
				"updated": "20230903114854"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "service.beta.kubernetes.io/alibaba-cloud-loadbalancer-connection-drain: \"on\"\nservice.beta.kubernetes.io/alibaba-cloud-loadbalancer-connection-drain-timeout: \"900\"\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230903114859-yw13puq",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230903114859-yw13puq",
				"updated": "20230903114859"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "参考官方文档 "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://help.aliyun.com/document_detail/86531.html",
					"TextMarkTextContent": "通过Annotation配置负载均衡"
				}
			]
		}
	]
}