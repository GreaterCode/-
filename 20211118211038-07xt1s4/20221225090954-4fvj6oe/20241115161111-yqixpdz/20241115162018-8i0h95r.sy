{
	"ID": "20241115162018-8i0h95r",
	"Spec": "1",
	"Type": "NodeDocument",
	"Properties": {
		"id": "20241115162018-8i0h95r",
		"title": "恢复疑似镜像缓存损坏的节点(针对标准交付环境)",
		"updated": "20241115162944"
	},
	"Children": [
		{
			"ID": "20241115162042-mh0twyo",
			"Type": "NodeList",
			"ListData": {
				"Typ": 1
			},
			"Properties": {
				"id": "20241115162042-mh0twyo",
				"updated": "20241115162440"
			},
			"Children": [
				{
					"ID": "20241115162042-3c11bs3",
					"Type": "NodeListItem",
					"ListData": {
						"Typ": 1,
						"Delimiter": 46,
						"Marker": "MS4=",
						"Num": 1
					},
					"Properties": {
						"id": "20241115162042-3c11bs3",
						"updated": "20241115162042"
					},
					"Children": [
						{
							"ID": "20241115162042-8y8bo6k",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20241115162042-8y8bo6k",
								"updated": "20241115162042"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "sudo -s 切换用户"
								}
							]
						}
					]
				},
				{
					"ID": "20241115162042-t25qu9i",
					"Type": "NodeListItem",
					"ListData": {
						"Typ": 1,
						"Delimiter": 46,
						"Marker": "Mi4=",
						"Num": 2
					},
					"Properties": {
						"id": "20241115162042-t25qu9i",
						"updated": "20241115162440"
					},
					"Children": [
						{
							"ID": "20241115162042-z7br1nm",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20241115162042-z7br1nm",
								"updated": "20241115162042"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "检查/var/lib/containers/storage目录下所有的层，如果镜像层损坏，会在输出结果看到"
								}
							]
						},
						{
							"ID": "20241115162044-x9cfufe",
							"Type": "NodeCodeBlock",
							"IsFencedCodeBlock": true,
							"Properties": {
								"id": "20241115162044-x9cfufe",
								"updated": "20241115162440"
							},
							"Children": [
								{
									"Type": "NodeCodeBlockFenceOpenMarker",
									"Data": "```"
								},
								{
									"Type": "NodeCodeBlockFenceInfoMarker"
								},
								{
									"Type": "NodeCodeBlockCode",
									"Data": "# 这个二进制没在版本里面，需要研发提供\nchmod +x  /root/containers-storage\n/root/containers-storage -D check\n"
								},
								{
									"Type": "NodeCodeBlockFenceCloseMarker",
									"Data": "```"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20241115162434-hehn9cx",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20241115162434-hehn9cx",
				"updated": "20241115162443"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "\t​"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "image"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "assets/image-20241115162127-anhtfup.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20241115162138-ianwt76",
			"Type": "NodeList",
			"ListData": {
				"Typ": 1
			},
			"Properties": {
				"id": "20241115162138-ianwt76",
				"updated": "20241115162138"
			},
			"Children": [
				{
					"ID": "20241115162138-jdvhzp6",
					"Type": "NodeListItem",
					"ListData": {
						"Typ": 1,
						"Delimiter": 46,
						"Marker": "My4=",
						"Num": 3
					},
					"Properties": {
						"id": "20241115162138-jdvhzp6",
						"updated": "20241115162138"
					},
					"Children": [
						{
							"ID": "20241115162138-7ezr2jw",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20241115162138-7ezr2jw",
								"updated": "20241115162138"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "根据显示异常的层的ID，查找其镜像ID (注意一个层可能关联了多个镜像，这里演示只用了第一个输出)"
								}
							]
						},
						{
							"ID": "20241115162139-qfyjx8f",
							"Type": "NodeCodeBlock",
							"IsFencedCodeBlock": true,
							"Properties": {
								"id": "20241115162139-qfyjx8f",
								"updated": "20241115162339"
							},
							"Children": [
								{
									"Type": "NodeCodeBlockFenceOpenMarker",
									"Data": "```"
								},
								{
									"Type": "NodeCodeBlockFenceInfoMarker"
								},
								{
									"Type": "NodeCodeBlockCode",
									"Data": "# 根据层ID，找出其镜像ID\nlayer_id=\"\u003c层的ID\u003e\"\n \ncrictl image -q \\\n  | while read -r imageid; do\n      podman image inspect --format '{{json .GraphDriver.Data}}' \"$imageid\" \\\n        | grep -q \"$layer_id\" \u0026\u0026 echo \"$imageid\"\n    done\n"
								},
								{
									"Type": "NodeCodeBlockFenceCloseMarker",
									"Data": "```"
								}
							]
						},
						{
							"ID": "20241115162339-z65trzn",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20241115162339-z65trzn",
								"updated": "20241115162348"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "​"
								},
								{
									"Type": "NodeImage",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeBang"
										},
										{
											"Type": "NodeOpenBracket"
										},
										{
											"Type": "NodeLinkText",
											"Data": "image"
										},
										{
											"Type": "NodeCloseBracket"
										},
										{
											"Type": "NodeOpenParen"
										},
										{
											"Type": "NodeLinkDest",
											"Data": "assets/image-20241115162348-ypev7qk.png"
										},
										{
											"Type": "NodeCloseParen"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "​"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20241115162459-8pcmth7",
			"Type": "NodeList",
			"ListData": {
				"Typ": 1
			},
			"Properties": {
				"id": "20241115162459-8pcmth7",
				"updated": "20241115162822"
			},
			"Children": [
				{
					"ID": "20241115162459-dojfgjf",
					"Type": "NodeListItem",
					"ListData": {
						"Typ": 1,
						"Delimiter": 46,
						"Marker": "NC4=",
						"Num": 4
					},
					"Properties": {
						"id": "20241115162459-dojfgjf",
						"updated": "20241115162822"
					},
					"Children": [
						{
							"ID": "20241115162459-z1k50vy",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20241115162459-z1k50vy",
								"updated": "20241115162459"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "根据损坏的镜像ID，查出可能的关联pod name (注意一个损坏的镜像可以暂时没有关联任何一个容器和pod，也可能关联了多个容器和pod，这里演示只用了第一个输出)"
								}
							]
						},
						{
							"ID": "20241115162512-969d23k",
							"Type": "NodeCodeBlock",
							"IsFencedCodeBlock": true,
							"Properties": {
								"id": "20241115162512-969d23k",
								"updated": "20241115162543"
							},
							"Children": [
								{
									"Type": "NodeCodeBlockFenceOpenMarker",
									"Data": "```"
								},
								{
									"Type": "NodeCodeBlockFenceInfoMarker"
								},
								{
									"Type": "NodeCodeBlockCode",
									"Data": "# 根据镜像ID, 找出关联的容器ID\ncrictl ps -a --image \u003c损坏的镜像的ID\u003e\n \n# 根据容器ID，找出这个容器对应的POD name和namespace\ncrictl inspect \u003c关联的容器的ID\u003e | jq .status.labels\n"
								},
								{
									"Type": "NodeCodeBlockFenceCloseMarker",
									"Data": "```"
								}
							]
						},
						{
							"ID": "20241115162547-waft9st",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20241115162547-waft9st",
								"updated": "20241115162822"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "​​"
								},
								{
									"Type": "NodeImage",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeBang"
										},
										{
											"Type": "NodeOpenBracket"
										},
										{
											"Type": "NodeLinkText",
											"Data": "image"
										},
										{
											"Type": "NodeCloseBracket"
										},
										{
											"Type": "NodeOpenParen"
										},
										{
											"Type": "NodeLinkDest",
											"Data": "assets/image-20241115162822-jbkn9p1.png"
										},
										{
											"Type": "NodeCloseParen"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "​​"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20241115162835-tebin14",
			"Type": "NodeList",
			"ListData": {
				"Typ": 1
			},
			"Properties": {
				"id": "20241115162835-tebin14",
				"updated": "20241115162944"
			},
			"Children": [
				{
					"ID": "20241115162935-nxy0gkt",
					"Type": "NodeListItem",
					"ListData": {
						"Typ": 1,
						"Delimiter": 46,
						"Marker": "NS4=",
						"Num": 5
					},
					"Properties": {
						"id": "20241115162935-nxy0gkt",
						"updated": "20241115162944"
					},
					"Children": [
						{
							"ID": "20241115162935-zzqp4t4",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20241115162935-zzqp4t4",
								"updated": "20241115162939"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "删除第3步发现的损坏镜像，然后删除第4步发现的关联pod\n"
								}
							]
						},
						{
							"ID": "20241115162941-symjddr",
							"Type": "NodeCodeBlock",
							"IsFencedCodeBlock": true,
							"Properties": {
								"id": "20241115162941-symjddr",
								"updated": "20241115162944"
							},
							"Children": [
								{
									"Type": "NodeCodeBlockFenceOpenMarker",
									"Data": "```"
								},
								{
									"Type": "NodeCodeBlockFenceInfoMarker"
								},
								{
									"Type": "NodeCodeBlockCode",
									"Data": "podman image rm \u003c损坏的镜像的ID\u003e --force\n \n# 在主节点上执行\nkubectl delete pod -n \u003c关联pod的namespace\u003e \u003c关联pod的name\u003e\n"
								},
								{
									"Type": "NodeCodeBlockFenceCloseMarker",
									"Data": "```"
								}
							]
						}
					]
				}
			]
		}
	]
}